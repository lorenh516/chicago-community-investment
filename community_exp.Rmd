---
title: "Chicago Community Investment Exploration"
output:
    html_document:
      df_print: paged
      toc: true
      toc_float: true
      code_folding: hide
---

```{r Housekeeping, echo=TRUE, message=FALSE, warning=FALSE, include=FALSE}
# Housekeeping (clear workspace, start output file, load packages)
# rm(list=ls())

# data cleaning, augmenting, manipulation
library(tidyverse)
library(dplyr)
library(haven)
# library(stargazer)
library(xtable)
library(readxl)
# library(astsa)
library(Hmisc)
library(tidycensus)
library(lubridate)
library(here)

# plotting tools
library(gridExtra)
library(ggplot2)
library(grid)
library(ggrepel)
library(gghighlight)
library(ggalt)
library(scales)
library(extrafont)
# font_import()
# loadfonts()
library(swatches)

# mapping tools
library(raster)
library(rgdal)
library(rgeos)
library(maptools)
library(tigris)
library(ggmap)
library(sf)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```


```{r include = FALSE}
monochromatic_C6C3FF <- c(
"#7d77ff",
"#9690ff",
"#aeaaff",
"#c6c3ff",
"#deddff",
"#f6f6ff")

diverging_teal <- read_ase(here::here("BrBG_9.ase"), use_names = FALSE)
diverging_teal[7] <- "#E5E5E5"
diverging_teal[5] <- "#8a89c1"
diverging_teal[6] <- "#9AEADE"
diverging_teal[4] <- "#FADC89"
diverging_teal[3] <- "#B5B5B5"
diverging_teal[2] <- "#E8B45B"
diverging_teal[1] <- "#E8B45B"
diverging_teal[10] <- "#FA8260"
names(diverging_teal) <-  c("cocoa", "honeymustard", "darkgray", "sand", "lavender", "seafoam", "palegray", "teal", "darkteal", "rust")
```



```{r include=FALSE}
# make it easy to select colors by name, thanks Dr. Simon J!
# Attribution: https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2
get_dt_cols <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (diverging_teal)
  diverging_teal[cols]
}
```

```{r}
# set groupings of colors as palettes
dt_palettes <- list(
  `main`  = get_dt_cols("teal", "darkteal", "honeymustard"),
  `diverging` = get_dt_cols("darkteal", "lavender", "sand", "honeymustard"),
  `cool`  = get_dt_cols("darkteal", "teal", "seafoam", "lavender"),
  `desert`   = get_dt_cols("sand", "honeymustard", "rust", "cocoa"),
  `mixed` = get_dt_cols("cocoa", "rust","honeymustard", "sand", "lavender", "seafoam", "teal", "darkteal"),
  `grey`  = get_dt_cols("palegray", "darkgray")
)
```




```{r include=FALSE}
# function for uilitizing palettes
dt_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- dt_palettes[[palette]]
  if (reverse) pal <- rev(pal)
  # pass alpha, other color arguments to colorRampPalette
  colorRampPalette(pal, ...)
}

# function for applying palettes to borders and fills in ggplot2
scale_color_dt <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- dt_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("colour", paste0("dt_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

scale_fill_dt <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- dt_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("dt_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}
```



```{r set_theme}
theme_modest <- function(base_size = 12,
                                  base_family = "Roboto",
                                  base_line_size = base_size / 25,
                                  base_rect_size = base_size / 25) {
  require(grid)
  theme_minimal(base_size = base_size, 
                base_family = base_family,
                base_line_size = base_line_size)  %+replace%
    theme(
        axis.title = element_text(size = rel(0.85)),
        axis.text = element_text(size = rel(0.6)),
        axis.ticks=element_line(colour="grey", size=0.5),
        panel.grid.major = element_line(colour="grey", size=0.4),
        panel.grid.minor = element_line(colour="lightgrey", size=0.25),
        legend.box = NULL, 
        legend.text = element_text(size = rel(0.75)),
        legend.key.height = NULL,
        legend.key.width = NULL,
        legend.key = element_rect(fill = NA, colour = NA),
        legend.background = element_rect(colour = NA, fill=NA), 
        legend.position = "right",
        legend.justification = "center", 
        plot.background = element_rect(colour = NA, fill=NA),
        plot.margin = unit(c(0,0,0,0),"lines"),
        plot.title = element_text(size = rel(1.5), face = "bold", hjust="0.5",  margin = margin(t = 15)),
        plot.subtitle = element_text(size = rel(1.25), face = "bold", hjust="0.5",  margin = margin(t = 15)),
        plot.caption = element_text(size = rel(0.75), hjust = 1),
        strip.background = element_rect(colour = NA, fill=NA),
        strip.text = element_text(face = "bold", size = rel(1.25)),
        panel.spacing = unit(0,"lines"),
        panel.border=element_blank(),
        complete = TRUE
    )
}
  
  

theme_map_modest <- function(base_size = 12) {
  require(grid)
  theme_modest(base_size) %+replace%
    theme(
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text = element_blank(),
        axis.ticks=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.border=element_blank(),
        panel.spacing = unit(0,"lines"),
        plot.margin  =  unit(c(2,2,2,2),"lines")
    )
}

theme_set(theme_modest(base_size = 12))
```


```{r import-licenses, message=FALSE, warning=FALSE}
# bus_licenses <- read_csv(here::here("data", "Business_Licenses.csv"))
bus_licenses <-  readRDS(here::here("data", "bus_licenses.Rda"))
```

```{r view-zip-problems, include=FALSE}
# problems(bus_licenses)
```


```{r check-zip-integrity, include=FALSE}
# investigate nonstandard zip codes
# looks like int'l businesses

# bind_cols(bus_licenses[unlist(problems(bus_licenses)[, 'row']), c('LICENSE ID', 'LEGAL NAME', 'DOING BUSINESS AS NAME', 'ADDRESS', 'CITY', 'STATE', 'BUSINESS ACTIVITY')], problems(bus_licenses)[, 'actual']) %>% arrange(ADDRESS) %>% distinct(`DOING BUSINESS AS NAME`, `BUSINESS ACTIVITY`, ADDRESS, CITY, STATE, actual)
```


```{r add-lic-cols, include=FALSE}
# bus_licenses <- mutate(bus_licenses, 
#                        active=ifelse(grepl("AAI",`LICENSE STATUS`),1,0),
#                        app_review = difftime(mdy(`LICENSE APPROVED FOR ISSUANCE`,tz="America/Chicago"), mdy(`APPLICATION REQUIREMENTS COMPLETE`,tz="America/Chicago"),unit="days"),
#                        license_term = difftime(mdy(`LICENSE TERM EXPIRATION DATE`,tz="America/Chicago"), mdy(`LICENSE TERM START DATE`,tz="America/Chicago"),unit="days"),
#                        activity_date = mdy(ifelse(is.na(`LICENSE STATUS CHANGE DATE`), `DATE ISSUED`, `LICENSE STATUS CHANGE DATE`),tz="America/Chicago"),
#                        activity_month = lubridate::month(activity_date),
#                        activity_yr = lubridate::year(activity_date)
#                        )
```


```{r include=FALSE}
wardSides <- read_csv(here::here("data", "wardSides.csv"))
```



```{r, include=FALSE}
# bus_licenses <- bus_licenses %>% mutate(activity_wk = lubridate::as_date(cut(activity_date, breaks = "week", start.on.monday = FALSE, origin = lubridate::origin)))
# bus_licenses <- left_join(bus_licenses, wardSides, by="WARD")
# saveRDS(bus_licenses, file = here::here("data", "bus_licenses.Rda"))
```


```{r pre-2015-lic, include=FALSE}
# data exploration
bus_licenses %>% group_by(activity_date, WARD) %>% summarise(business_count = n()) %>% 
  filter(activity_date < mdy("1/1/2015"), !is.na(WARD)) %>%
  ggplot() + geom_line(aes(x=activity_date, y=business_count, colour=as.factor(WARD))) +
  gghighlight(min(business_count), max_highlight = 3L) +
  labs(y="Business Count", x="Activity Date", colour="Ward", 
       title="Chicago Ward Business Presence", 
       caption="Data Source: Chicago Open Data Portal") + 
  theme_modest() + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_color_dt() 
```

```{r check-2012-spike, include=FALSE}
# look into spike around beginning of 2013
bus_licenses %>% group_by(activity_date, WARD) %>% summarise(bus_count = n()) %>% summarise(max_activity = max(bus_count)) %>% arrange(desc(max_activity))
```

```{r pre-2015-licensing, echo=FALSE}
bus_licenses %>% filter(active==1, activity_date < mdy("1/1/2015"), !is.na(WARD), !(activity_date== mdy("12/29/2012"))) %>%
  group_by(activity_date, WARD) %>% summarise(business_count = n()) %>% 
  ggplot() + geom_line(aes(x=activity_date, y=business_count, colour=as.factor(WARD))) +
  gghighlight(min(business_count), max_highlight = 3L) +
  labs(y="Business Count", x="Activity Date", colour="Ward", 
       title="Chicago Ward Business Presence (2002-2015)", 
       caption="Data Source: Chicago Open Data Portal") + 
  theme_modest() + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_color_dt() 
```


```{r save-pre-2015-licensing, include=FALSE}
# ggsave("pre_2015_licensing.pdf", width = 30, height = 15, units = "cm")
```


```{r import-former-wards, include=FALSE}
# wardsPre2015 <- sf::st_read(here::here("data","Geofiles - Chicago Zip Code and Neighborhood", "Boundaries - Wards (2003-2015)","geo_export_fa687596-87b6-4059-afac-b28ce789a674.shp"))
# 
# wardsPre2015 <-wardsPre2015 %>% mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]), # add centroid values for labels
#                                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])) # add centroid values for labels
```




```{r include=FALSE}
# run API key
tidycensus::census_api_key(Sys.getenv("CENSUS_API_KEY"))

# cache census shapefiles
# tigris_cache_dir(here::here("data", "tigris_cache"))
# options(tigris_use_cache = TRUE)
# readRenviron('~/.Renviron')
```


```{r  include=FALSE}
# want to know: how population changing/ not changing across tracts - race, age, income, poverty status, safety net takeup
getDemos <- function(acs_year) {
  tidycensus::get_acs(geography = "tract", 
              variables = c(medianIncome = 'B19013_001',
                            perCapitaIncome = 'B19301_001',
                            population = 'B02001_001',
                            belowPovertyPop = 'B17001_002',
                            whitePop = 'B02001_002',
                            blackPop = 'B02001_003',
                            latinxPop = 'B03001_003',
                            asianPop = 'B02001_005',
                            citizenshipPop = 'B05001_001',
                            naturalized = 'B05001_005',
                            noncitizen = 'B05001_006',
                            mobilityPop = 'B07001_001',
                            movedInsideCounty = 'B07001_033',  #hipster age movement inside Cook County
                            movedInside20to24 = 'B07001_021',  #hipster age movement inside Cook County
                            movedInside25to29 = 'B07001_022', 
                            medAgemovedInside = 'B07002_003',
                            renterPop = 'B07013_001',
                            owners = 'B07013_002',
                            renters = 'B07013_003',
                            transportPop = 'B08122_001',
                            publicTransport = 'B08122_013',
                            households = 'B22001_001',
                            householdsSNAP = 'B22001_002',
                            householdsKidsSNAP = 'B22002_003',
                            kidsHealthIns = 'B27001_007',
                            medicarePop = 'C27006_001',
                            maleChildMedicare = 'C27006_004',
                            maleMedicare18_64 = 'C27006_007',
                            maleMedicare65_up = 'C27006_010',
                            femaleMedicare18_64 = 'C27006_017',
                            femaleMedicare65_up = 'C27006_020',
                            femaleChildMedicare = 'C27006_014',
                            medicaidPop = 'C27007_001',
                            maleChildMedicaid = 'C27007_004',
                            maleMedicaid18_64 = 'C27007_007',
                            maleMedicaid65_up = 'C27007_010',
                            femaleMedicaid18_64 = 'C27007_017',
                            femaleMedicaid65_up = 'C27007_020',
                            femaleChildMedicaid = 'C27007_014'
                            ), 
              year = acs_year,
              state = 17, # IL = 17
              county = 031, # Cook County = 031 FIPS
              geometry = TRUE)
}
```


```{r  include=FALSE}

demoConversion <- function(acs_year) {
  demo_df <- getDemos(acs_year=acs_year)
  demo_df <- demo_df %>% dplyr::select(-one_of("moe")) %>% spread(variable, estimate)
  demo_df <- demo_df %>% mutate(
                      asian_pct = asianPop/ population,
                      black_pct = blackPop / population,
                      latinx_pct = latinxPop/ population,
                      white_pct = whitePop/ population,
                      other_pct = ifelse((population - blackPop - latinxPop - whitePop - asianPop) / population > 0, 
                                         (population - blackPop - latinxPop - whitePop - asianPop) / population, NA),
                      below_poverty_pct = belowPovertyPop / population,
                      childMedicaid_pct = (femaleChildMedicaid + maleChildMedicaid) / medicarePop,
                      childMedicare_pct = (femaleChildMedicare + maleChildMedicare) / medicarePop,
                      takeupMedicare_pct = (maleChildMedicare + maleMedicare18_64 + maleMedicare65_up +
                          femaleChildMedicare + femaleMedicare18_64 + femaleMedicare65_up) / medicarePop,
                      takeupMedicaid_pct = (maleChildMedicaid + maleMedicaid18_64 + maleMedicaid65_up +
                          femaleChildMedicaid + femaleMedicaid18_64 + femaleMedicaid65_up) / medicaidPop,
                      households_kidsSNAP_pct = householdsKidsSNAP / households,
                      takeupSNAP_pct = householdsSNAP / households,
                      YAmovesInChi_pct = (movedInside20to24 + movedInside25to29) / mobilityPop,
                      movesInChi_pct = movedInsideCounty / mobilityPop,
                      immigrant_pct = (naturalized + noncitizen) / citizenshipPop,
                      renting_pct = renters / renterPop,
                      public_transport_pct = publicTransport / transportPop
                      ) %>% dplyr::select(GEOID, NAME, medianIncome, perCapitaIncome, population, medAgemovedInside, contains("_pct"), geometry)
  
    demo_df <- left_join(demo_df, as.data.frame(demo_df) %>% 
                           dplyr::select(GEOID, NAME, black_pct, latinx_pct, asian_pct, white_pct, other_pct) %>%
                           group_by(GEOID, NAME) %>% 
                           gather(group_name, pct, -GEOID, -NAME) %>% 
                           slice(which.max(pct)) %>% mutate(predominant_race = ifelse(group_name == 'black_pct', 'Black',
                                                       ifelse(group_name == 'white_pct', 'White',
                                                       ifelse(group_name == 'asian_pct', 'Asian',
                                                       ifelse(group_name == 'latinx_pct', 'Latinx',
                                                       ifelse(group_name == 'other_pct', 'Other')))))) %>% 
                           dplyr::select(GEOID, NAME, predominant_race, max_pct = pct), by = c("GEOID", "NAME")
                       )
    return(demo_df)
}
```


```{r echo=TRUE, include=FALSE}
# test that census calls working
# getDemos(2013)
```



```{r message=FALSE,  include=FALSE}
# years <- list(2012, 2013, 2014, 2015, 2016, 2017)
# 
# multi_year <-
#   map(.x = years, .f=demoConversion) %>%
#   map2(.y = years, ~ mutate(.x, id = .y))
# 
# all_demos <- reduce(multi_year, rbind)
# rm(multi_year)
```

```{r  include=FALSE}
# saveRDS(all_demos, file = here::here("data", "all_demos_chi.Rda"))
```


```{r fortify-mapping, message=FALSE, include=FALSE}

# wards.2015 <- sf::st_read(here::here("data","Geofiles - Chicago Zip Code and Neighborhood","Boundaries - Wards (2015-)","geo_export_0bb2e9fd-20ca-415b-a96a-7722d72c1b41.shp"))
```

```{r  include=FALSE}
# all_demos <-st_transform(all_demos, crs =  st_crs(wards.2015))
# saveRDS(all_demos, file = here::here("data", "all_demos_chi_proj.Rda"))
# 
# # wards.2015.acs.proj <- st_transform(wards.2015, crs = st_crs(all_demos))
# # wards.2015.acs.proj <- wards.2015.acs.proj %>% mutate(long=map_dbl(geometry, ~st_centroid(.x)[[1]]), # add centroid values for labels
# #                                                       lat=map_dbl(geometry, ~st_centroid(.x)[[2]])) # add centroid values for labels
# 
# wards.2015 <- wards.2015  %>% mutate(long=map_dbl(geometry, ~st_centroid(.x)[[1]]), # add centroid values for labels
#                                                       lat=map_dbl(geometry, ~st_centroid(.x)[[2]])) # add centroid values for labels
# 
# saveRDS(wards.2015, file = here::here("data", "wards2015_sf.Rda"))
# 
# # all.demos.Chi <- st_intersection(all_demos, wards.2015.acs.proj)
```

```{r}
# all_demos <-  readRDS(here::here("data", "all_demos_chi.Rda"))
all_demos.Chi <- readRDS(here::here("data", "all_demos_chi_proj.Rda"))
wards.2015 <-  readRDS(here::here("data", "wards2015_sf.Rda"))
```


```{r facet_wrap_demo_info, message=FALSE, warning=FALSE, fig.width=15, fig.height=17}
chiCentralLongitude <- median(wards.2015$long)

ggplot(st_intersection(all_demos.Chi, wards.2015) %>% filter(!is.na(predominant_race))) +
  geom_sf(aes(fill=predominant_race, alpha=max_pct), lwd = 0) +
  scale_fill_dt("diverging", reverse=TRUE) +
  scale_alpha(range = c(0.35, 0.9), guide="none") + 
  geom_sf(data = wards.2015, color="black", fill=NA) +
    geom_text_repel(data=wards.2015 %>% filter(ward %in% c(10, 18)), 
                  aes(x=long, y=lat, label=ward),
                  fontface="bold",
                  force = 5,
                  size = 6,
                  direction = "both",
                  hjust=0) +
  geom_text_repel(data=wards.2015 %>% filter(ward %in% c(9, 13, 14, 33, 34)), 
                  aes(x=long, y=lat, label=ward),
                  nudge_x = -.35,
                  segment.size = 0.5,
                  segment.color = get_dt_cols("cocoa"),
                  fontface="bold",
                  size = 6,
                  force = 5,
                  direction = "both",
                  hjust=0) +
  geom_text_repel(data = wards.2015 %>% filter(ward %in% c(11)), 
                  aes(x=long, y=lat, label=ward),
                  nudge_x = .15,
                  segment.size = 0.5,
                  segment.color = get_dt_cols("cocoa"),
                  fontface="bold",
                  size = 6,
                  force = 10,
                  direction = "both",
                  hjust = 1) +
  coord_sf(datum = NA) +
  theme_map_modest() + 
  theme(plot.margin = unit(c(20, 0, 0, 0), "pt"),
        legend.title = element_text(size=15),
        legend.text = element_text(size=12),
        plot.title = element_text(size = 20, face = "bold", hjust="0.5", margin = margin(t = 15)),
        plot.subtitle = element_text(size = 15, margin = margin(t = 15)),
        plot.caption = element_text(size = 15)) +
  facet_wrap( ~ id) + labs(
    title = "Latinx Populations in Chicago\nPushed to South, West Neighborhoods",
    subtitle = "Chicago Racial and Ethnic Group Movement\nby Census Tract Since 2012 (5 year averages)",
    caption = "Source: U.S. Census Bureau", fill = "Predominant Race in Tract")
  
```


```{r save-bus-locs, warning=FALSE, include = FALSE}
ggsave("ward_demographics.pdf", width = 30, height = 25, units = "cm")
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# voter_turnout15 <- read_csv(here::here("data", "voter_turnout_city_council_2015.csv"), col_names = FALSE, skip=8)
# voter_turnout15 <- voter_turnout15 %>% mutate(WARD = ifelse(grepl("WARD", voter_turnout15$X1), as.numeric(gsub("WARD ", "", X1)), NA),
#                                               X4 = as.numeric(gsub("%", "", X4)),
#                                               YEAR = 2015)
# voter_turnout15 <- voter_turnout15 %>% fill(WARD)
```

```{r include=FALSE}
# double-check columns that look empty
# voter_turnout15 %>% dplyr::select(X5, X6) %>% distinct()
```

```{r include=FALSE}
# voter_turnout15 <- voter_turnout15 %>% dplyr::select(-c(X5, X6))
# names(voter_turnout15) <- sapply(c("Precinct","Registered","Ballots","Turnout", "WARD", "YEAR"), toupper)
# voter_turnout15 <- voter_turnout15 %>% filter(PRECINCT !="Precinct", !grepl("WARD", PRECINCT), !is.na(PRECINCT))
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# voter_turnout11 <- read_csv(here::here("data", "voter_turnout_city_council_2011.csv"), col_names = FALSE, skip=8)
# voter_turnout11 <- voter_turnout11 %>% mutate(WARD = ifelse(grepl("WARD", voter_turnout11$X1), as.numeric(gsub("WARD ", "", X1)), NA),
#                                               X4 = as.numeric(gsub("%", "", X4)),
#                                               YEAR=2011)
# voter_turnout11 <- voter_turnout11 %>% fill(WARD)
```


```{r include=FALSE}
# double-check columns that look empty
# voter_turnout11 %>% dplyr::select(X5, X6) %>% distinct()
```

```{r include=FALSE}
# voter_turnout11 <- voter_turnout11 %>% dplyr::select(-c(X5, X6))
# names(voter_turnout11) <- sapply(c("Precinct","Registered","Ballots","Turnout", "WARD", "YEAR"), toupper)
# voter_turnout11 <- voter_turnout11 %>% filter(PRECINCT !="Precinct", !grepl("WARD", PRECINCT), !is.na(PRECINCT))
```


```{r include=FALSE}
# voterTurnout <- bind_rows(voter_turnout11, voter_turnout15)
# voterTurnout <- voterTurnout %>% 
#   mutate(TURNOUT = round((as.numeric(gsub(",", "", BALLOTS)) / as.numeric(gsub(",", "", REGISTERED))) * 100,1))
# rm(voter_turnout11, voter_turnout15)
```



```{r include=FALSE}
# turnoutSides <- merge(voterTurnout, wardSides, by="WARD") %>% filter(PRECINCT=="Total") %>% 
#   group_by(YEAR, SIDE) %>% summarise(MEAN_TURNOUT = round(mean(TURNOUT, na.rm = TRUE), 1)) %>% 
#   spread(YEAR, MEAN_TURNOUT) %>% mutate(DIFFERENCE = `2015` - `2011`) %>% 
#   gather("YEAR", "TURNOUT", -SIDE, -DIFFERENCE) %>% 
#   mutate(DIFFERENCE = ifelse(YEAR==2011, NA, DIFFERENCE)) %>% 
#   dplyr::select(YEAR, everything()) %>% 
#   arrange(SIDE, YEAR)
# 
# saveRDS(turnoutSides, file = here::here("data", "sides_turnout.Rda"))                                  
```


```{r include=FALSE}
# turnoutDiff <- voterTurnout %>%filter(PRECINCT=="Total", YEAR %in% c(2011, 2015)) %>% dplyr::select(WARD, TURNOUT, YEAR) %>% 
#   group_by(YEAR, WARD) %>%
#   spread(YEAR, TURNOUT) %>% mutate(DIFFERENCE = `2015` - `2011`) %>% 
#   gather("YEAR", "TURNOUT", -WARD, -DIFFERENCE) %>% 
#   mutate(DIFFERENCE = ifelse(YEAR==2011, NA, DIFFERENCE)) %>% 
#   dplyr::select(YEAR, WARD, TURNOUT, DIFFERENCE) %>% 
#   arrange(YEAR, WARD) %>% group_by(WARD) %>% merge(., wardSides, by="WARD")

# saveRDS(turnoutDiff, file = here::here("data", "wards_turnout.Rda"))
``` 


```{r slopegraph, fig.width=10, fig.height=12}
  turnoutSides <-  readRDS(here::here("data", "sides_turnout.Rda"))
  turnoutDiff <-  readRDS(here::here("data", "wards_turnout.Rda"))

  ggplot(turnoutSides, aes(x=as.factor(YEAR), y=TURNOUT, group=as.factor(SIDE))) + 
  geom_line(size=1.5, alpha=0.75, color="grey", show.legend = FALSE) +
  geom_line(data = filter(turnoutSides, (DIFFERENCE > -0)||(is.na(DIFFERENCE))), aes(colour=SIDE), size=1.5, show.legend=FALSE) +
  scale_color_dt("mixed", reverse = TRUE) + 
  geom_line(data = turnoutDiff, aes(group=as.factor(WARD), color=SIDE), size=0.5, alpha=0.25, show.legend = FALSE) +
  geom_label(data = turnoutDiff %>% group_by(YEAR, SIDE) %>% summarise(MEAN_TURNOUT = round(mean(TURNOUT, na.rm=TRUE),1)),
            aes(x=as.factor(YEAR), y= MEAN_TURNOUT, label = paste0(MEAN_TURNOUT, "%"), group=as.factor(SIDE)),
            color = "darkgray",
            label.padding = unit(0.05, "lines"),
            label.size = 0.0,
            fontface = "bold",
            size = 4) +
  geom_label_repel(data = turnoutSides %>% filter(YEAR == 2011),
            aes(label = paste0(SIDE), color = SIDE),
            fill=NA,
            hjust = "left",
            nudge_x = -.25,
            force=5,
            direction = "both",
            fontface = "bold",
            point.padding	= 3,
            size = 5,
            show.legend = FALSE) +
  geom_label_repel(data = turnoutSides %>% filter(YEAR == 2015),
            aes(label = paste0(SIDE), color = SIDE),
            fill=NA,
            hjust = "right",
            nudge_x = .25,
            force = 7.5,
            direction = "both",
            fontface = "bold",
            point.padding	= 3,
            size = 5,
            show.legend = FALSE) +
  scale_x_discrete(position = "top") +
   # coord_cartesian(ylim=c(23.5, 60)) +
  theme_modest() + 
  theme(axis.text.x.top = element_text(size=15, vjust = -8, face="bold"),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.y = element_blank(),
          plot.caption = element_text(size = 12),
          panel.grid.minor=element_blank(),
          panel.grid.major=element_blank()) +
  labs(title="Highest Voter Turnout In Wards Facing Deinvestment", 
         subtitle="Change in Voter Turnout Between 2011 and 2015 Chicago City Council Elections", 
         caption="Source: Chicago Board of Election Commissioners", color="Chicago Area")
```


```{r include=FALSE}
ggsave("ward_election_turnout2011_2015.pdf", width = 36, height = 23, units = "cm")
```


```{r avg-monthly-lic, warning=FALSE, fig.width=15, fig.height=12}
bus_licenses %>% filter(!is.na(WARD), active==1) %>%
  group_by(activity_month, activity_yr, WARD, SIDE) %>% 
  summarise(business_count = n()) %>% group_by(WARD) %>% arrange(desc(business_count)) %>% 
  ggplot(aes(x=reorder(WARD, business_count, FUN = median), y=business_count)) + 
  geom_boxplot(aes(group=as.factor(WARD), fill=as.factor(SIDE)), alpha=0.5) + 
  scale_fill_dt("mixed") +
  geom_text(data = bus_licenses %>% filter(!is.na(WARD), active==1) %>%
                    group_by(activity_month, activity_yr, WARD, SIDE) %>% 
                    summarise(business_count = n()) %>% group_by(WARD) %>% arrange(desc(business_count)) %>% 
                     summarise(median_issuances = median(business_count)) %>% arrange(median_issuances),
                   aes(x=as.factor(WARD), y = median_issuances + 8, group=as.factor(WARD), label=as.factor(WARD)),
            color="#6E2C49", fontface="bold") + 
  scale_y_continuous(limits = c(0, 750)) +
  # scale_x_discrete(breaks=seq(0,50,5)) + 
  labs(x="Chicago Council Ward", y="Average Monthly Business Count", caption="Data Source: Chicago Open Data Portal", title="Least New & Surviving Businesses in South, West Wards for 15+ Years", subtitle="Calumet Heights, Westlawn Average less than 25 Business License Issuances per month ",fill="Chicago Area") + 
  theme_modest() +
  theme(
        plot.margin = unit(c(20, 0, 0, 0), "pt"),
        panel.grid.major.x = element_blank(),
        axis.ticks =  element_blank(),
        axis.title =  element_text(size=12),
        legend.title = element_text(size=15),
        legend.text = element_text(size=12),
        axis.text.x = element_blank(),
        plot.title = element_text(size = 20, face = "bold", hjust="0.5", margin = margin(t = 15)),
        plot.subtitle = element_text(size = 15, margin = margin(t = 15)),
        plot.caption = element_text(size = 15)
        )
  
```

```{r save-new-bus, warning=FALSE, include=FALSE}
ggsave("avg_ward_business.pdf", width = 25, height = 18, units = "cm")
```


```{r register-google-api, message=FALSE, warning=FALSE, include=FALSE}

register_google(key = Sys.getenv("GOOGLEMAPS_KEY"))
```

```{r ggmap-shapefiles}
wards.shp.2015 <- here::here("data","Geofiles - Chicago Zip Code and Neighborhood","Boundaries - Wards (2015-)","geo_export_0bb2e9fd-20ca-415b-a96a-7722d72c1b41.shp")
wards2015 <- shapefile(wards.shp.2015)
wards2015@data <- mutate(wards2015@data, id = rownames(wards2015@data))
wards2015.points <- fortify(wards2015, region="id")
wards2015.df <- merge(wards2015.points, wards2015@data, by="id")
```


```{r ggmapping, message=FALSE, warning=FALSE, fig.width=15, fig.height=24}
license_types <- c("ISSUE" = "New Business Licenses", 
                   "RENEW" = "Business License Renewals")  

bl <- bus_licenses %>% filter(activity_yr >= 2009, active == 1, `APPLICATION TYPE`%in% c('ISSUE', 'RENEW')) %>% 
    distinct(`LICENSE ID`, activity_yr, `APPLICATION TYPE`, LONGITUDE, LATITUDE) 
  
  ggmap::ggmap(ggmap::get_googlemap(center = c(lon = -87.732125, lat = 41.83379),
                      zoom = 10, scale = 1,
                      maptype ='terrain',
                      color = 'color',
                      key = Sys.getenv("GOOGLEMAPS_KEY"))) + 
    geom_point(data=bl, aes(x=LONGITUDE, y=LATITUDE, color=as.factor(activity_yr)), alpha = 0.05, show.legend = FALSE, na.rm = TRUE) + 
    geom_path(data = wards2015.df, aes(long,lat,group=group), color="black") +
    geom_polygon(data = wards2015.df, aes(long,lat,group=group), fill=NA) + 
    scale_color_dt("desert") +
    labs(y="Latitude", x="Longitude", colour="Year", title="Money in the Middle", 
         subtitle="Virtually No New Business Entry, Renwal in Chicago Wards 9, 10, 18, or 41 since\n2009", 
         caption = "Data Source: City of Chicago Department of Business Affairs and Consumer Protection"
         ) +
    theme_modest() + 
    facet_grid(. ~ `APPLICATION TYPE`, labeller=as_labeller(license_types)) +
    theme(
      panel.border = element_blank(),
      axis.text.y = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      plot.title = element_text(size = 20, face = "bold", hjust="0.5", margin = margin(t = 15)),
      plot.subtitle = element_text(size = 15,  hjust="0.5", margin = margin(t = 20)),
      plot.caption = element_text(size = 15)
    ) +
    scale_x_continuous(limits = c(wards2015.df %>% dplyr::select(long) %>% min() - 0.1, wards2015.df %>% dplyr::select(long) %>% max() + 0.05), expand = c(0, 0)) +
    scale_y_continuous(limits = c(wards2015.df %>% dplyr::select(lat) %>% min() - 0.1, wards2015.df %>% dplyr::select(lat) %>% max()) + 0.05, expand = c(0, 0))
```



```{r include=FALSE}
ggsave("location_over_googlemap_zoom10.pdf", width = 36, height = 23, units = "cm")
```







