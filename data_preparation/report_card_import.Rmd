---
title: "Chicago Public Schools Data Import"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```



```{r Housekeeping, echo=TRUE, message=FALSE, warning=FALSE, include=FALSE}
# Housekeeping (clear workspace, start output file, load packages)
# rm(list=ls())
library(Hmisc)
library(haven)
library(readxl)
library(lubridate)
library(tidyverse)
library(here)
```



## Import and Format Report Card files from ISBE
```{r}
importReportCards <- function(file, year, layout) {
   repCard <- read.delim(here::here("data", file), header = FALSE, sep=";")
   print(paste("layout length: ", nrow(layout)))
   print(paste("report card columns: ", ncol(repCard)))
   
   if (colnames(repCard) == nrow(layout)) {
      names(repCard) = layout %>% dplyr::select(X__6)
   } else if (ncol(repCard) > nrow(layout)) {
      name_vec = layout$descriptions
      names(repCard) <-  append(name_vec, sprintf("V%1d", 1:(ncol(repCard) - nrow(layout))))
   }
   
   cols = colnames(repCard)
   if ("DistNAME" %in% cols) {
      repCard <-  repCard %>% filter(grepl("City of Chicago",`DISTRICT NAME`))
   } else if ("District" %in% cols) {
       repCard <-  repCard %>% filter(grepl("City of Chicago",`DISTRICT NAME`))
   } else if ("DISTRICT NAME" %in% cols) {
       repCard <- repCard %>% filter(grepl("City of Chicago",`DISTRICT NAME`))
   } else {
     print("Error: Check District column name")
   }

   id_info = c("SCHOOL ID (R-C-D-T-S)", "SCHOOL TYPE CODE (0,1,2,C)", "SCHOOL NAME", "DISTRICT NAME", "CITY", "COUNTY")
   repCard <- repCard %>% dplyr::select(id_info, contains("SCHOOL"))
   repCard <-  mutate(repCard, YEAR = year)
   return(repCard)
   } 
```



```{r}
processLayout <- function(file, sheet, colnames) {
  layout = read_excel(here::here("data", file), sheet=sheet, col_names=colnames)
  layout = layout %>% filter(!is.na(as.numeric(X__1)))
  layout = layout %>% dplyr::select(-one_of(c("X__2")))
  layout = mutate(layout, descriptions = toupper(ifelse(is.na(X__3),X__6, paste(X__6, " - ", X__3))))
  return(layout)
}
```


#### Identify Common Phrases in Key Columns Across Years
```{r}
rc_key_phrases <- c("Summative Designation", "Low-Income", "Enrollment", "School Days", "Attendance Rate", "Truancy",	"Truant", "Truants", "Dropout", 'Dropout Rate', "DROPOUT RATE SCHOOL %", "Graduation Rate", "Grad Rate", "Class Size", "Teaching Exp", "Teacher Exp", "Teaching Exp.", "Teacher Exp.", "Teaching Experience", "Provisional Credentials", "Teacher Ratio", "Admin Ratio", "Pupil-Teacher", "Pupil-Admin", "Teacher Avg Salary", "Admin Avg Salary", "Teacher Retention", "Principal Turnover",	"Teacher Attendace", "Teacher Evaluation", "AP Classes", "AP Exams")
rc_key_phrases <- sapply(rc_key_phrases, toupper)
```


#### Identify Key Columns for Basic School Information
```{r}
# columns to be placed at beginning of final data frame
id_info <- c("YEAR", "SCHOOL ID (R-C-D-T-S)", "SCHOOL NAME", "DISTRICT NAME", "CITY", "COUNTY", "SCHOOL TYPE NAME", "GRADES IN SCHOOL", "SCHOOL - WHITE %", "SCHOOL - BLACK %", "SCHOOL - HISPANIC %", "SCHOOL - ASIAN %", "LOW-INCOME SCHOOL %")
```

#### Import Individual Files
```{r include=FALSE}
rc15Layout <- processLayout(file="RC15-layout.xlsx", sheet="RC15", colnames=FALSE)
```

```{r include=FALSE}
rc15 <- importReportCards("rc15.txt", "2015", rc15Layout)
```

```{r}
rc15 %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")))
```

```{r}
rc16Layout <- processLayout(file="RC16-layout.xlsx", sheet="RC16", colnames=FALSE)
```

```{r}
rc16 <- importReportCards("rc16.txt", "2016", rc16Layout)
```

```{r}
rc16 %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")))
```


```{r}
rc17Layout <- processLayout(file="RC17_layout.xlsx", sheet="RC17", colnames=FALSE)
```

```{r}
rc17 <- importReportCards("rc17.txt", "2017", rc16Layout)
```

```{r}
rc17 %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")))
```

#### Limit Columns to Identified Key Columns
```{r}
rc15 <- rc15 %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")))
rc16 <- rc16 %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")))
rc17 <- rc17 %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")))
```


```{r}
ncol(rc15)
ncol(rc16)
ncol(rc17)
```

#### Combine 2015-2017 data frames
```{r}
full_term <- plyr::rbind.fill(rc15, rc16, rc17)
```

####  Import 2018
```{r}
rc18 <- read_xlsx(here::here("data", "Report-Card-Public-Data-Set.xlsx"), sheet = "General")
rc18 <- mutate(rc18, YEAR="2018")
colnames(rc18) <- sapply(colnames(rc18), toupper)
```

```{r include=FALSE}
rc18 <- rc18 %>% rename(
  "SCHOOL ID (R-C-D-T-S)" = "RCDTS",
  "SCHOOL TYPE NAME" = "SCHOOL TYPE",
  "GRADES IN SCHOOL" = "GRADES SERVED",
  "DISTRICT NAME" = "DISTRICT",
  "SCHOOL - WHITE %" = "STUDENT ENROLLMENT - WHITE %", 
  "SCHOOL - BLACK %" = "STUDENT ENROLLMENT - BLACK OR AFRICAN AMERICAN %",
  "SCHOOL - HISPANIC %" = "STUDENT ENROLLMENT - HISPANIC OR LATINO %",
  "SCHOOL - ASIAN %" = "STUDENT ENROLLMENT - ASIAN %",
  "SCHOOL TOTAL ENROLLMENT"  = "STUDENT ENROLLMENT - TOTAL",
  "LOW-INCOME SCHOOL %" = "STUDENT ENROLLMENT - LOW INCOME %",
  "TOTAL SCHOOL DAYS - SCHOOL" = "TOTAL NUMBER OF SCHOOL DAYS",
  "ATTENDANCE RATE SCHOOL %  -  ALL" = "STUDENT ATTENDANCE RATE",
  "ATTENDANCE RATE SCHOOL %  -  MALE" = "STUDENT ATTENDANCE RATE - MALE",
  "ATTENDANCE RATE SCHOOL %  -  FEMALE" = "STUDENT ATTENDANCE RATE - FEMALE",
  "ATTENDANCE RATE SCHOOL %  -  WHITE" = "STUDENT ATTENDANCE RATE - WHITE",
  "ATTENDANCE RATE SCHOOL %  -  HISPANIC" = "STUDENT ATTENDANCE RATE - HISPANIC OR LATINO",
  "CHRONIC TRUANTS RATE SCHOOL %" = "STUDENT CHRONIC TRUANCY RATE",
  "ATTENDANCE RATE SCHOOL %  -  BLACK" = "STUDENT ATTENDANCE RATE - BLACK OR AFRICAN AMERICAN",
  "ATTENDANCE RATE SCHOOL %  -  ASIAN" = "STUDENT ATTENDANCE RATE - ASIAN",
  "CHRONIC TRUANTS # - SCHOOL" = "CHRONICALLY TRUANT STUDENTS",
  "DROPOUT RATE  SCHOOL %" = "HIGH SCHOOL DROPOUT RATE - TOTAL",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  ALL" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - TOTAL",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  MALE" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - MALE",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - FEMALE",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - WHITE",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - BLACK OR AFRICAN AMERICAN",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - HISPANIC OR LATINO",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - ASIAN",
  "HS 4-YEAR GRAD RATE SCHOOL %  -  LOW INCOME" = "HIGH SCHOOL 4-YEAR GRADUATION RATE - LOW INCOME",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  ALL" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - TOTAL",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  MALE" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - MALE",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - FEMALE",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - WHITE",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - BLACK OR AFRICAN AMERICAN",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - HISPANIC OR LATINO",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - ASIAN",
  "HS 5-YEAR GRAD RATE SCHOOL %  -  LOW INCOME" = "HIGH SCHOOL 5-YEAR GRADUATION RATE - LOW INCOME",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  ALL" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - TOTAL",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  MALE" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - MALE",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - FEMALE",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - WHITE",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - BLACK OR AFRICAN AMERICAN",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - HISPANIC OR LATINO",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HIGH SCHOOL 6-YEAR GRADUATION RATE - ASIAN",
  "HS 6-YEAR GRAD RATE SCHOOL %  -  LOW INCOME"  = "HIGH SCHOOL 6-YEAR GRADUATION RATE - LOW INCOME",
  "AVG CLASS SIZE - SCHOOL (KG)" = "AVG CLASS SIZE - KINDERGARTEN",
  "AVG CLASS SIZE - SCHOOL (GR1)" = "AVG CLASS SIZE - 1",
  "AVG CLASS SIZE - SCHOOL (GR2)" = "AVG CLASS SIZE - 2",
  "AVG CLASS SIZE - SCHOOL (GR3)" = "AVG CLASS SIZE - 3",
  "AVG CLASS SIZE - SCHOOL (GR4)" = "AVG CLASS SIZE - 4",
  "AVG CLASS SIZE - SCHOOL (GR5)" = "AVG CLASS SIZE - 5",
  "AVG CLASS SIZE - SCHOOL (GR6)" = "AVG CLASS SIZE - 6",
  "AVG CLASS SIZE - SCHOOL (GR7)" = "AVG CLASS SIZE - 7",
  "AVG CLASS SIZE - SCHOOL (GR8)" = "AVG CLASS SIZE - 8",
  "AVG CLASS SIZE - SCHOOL (H.S.)" = "AVG CLASS SIZE - HIGH SCHOOL",
  "OVERALL AVERAGE CLASS SIZE - SCHOOL" = "AVG CLASS SIZE â€“ ALL GRADES",
  "TEACHER RETENTION RATE (SCHOOL)" = "TEACHER RETENTION RATE",
  "# OF PRINCIPAL TURNOVER WITHIN 6 YEARS (SCHOOL)"  = "PRINCIPAL TURNOVER WITHIN 6 YEARS",
  "TEACHER ATTENDANCE RATE (SCHOOL)  -  ALL" = "TEACHER ATTENDACE RATE",
  "# OF CTE ENROLLMENT (SCHOOL)" = "# OF CTE ENROLLMENT",
  "# OF AP EXAMS TAKEN BY GRADE 10 STUDENTS (SCHOOL)" = "TOTAL AP EXAMS GRADE 10",
  "# OF AP EXAMS PASSED BY GRADE 10 STUDENTS (SCHOOL)" = "TOTAL AP EXAMS RESULTING IN COLLEGE CREDIT GRADE 10",
  "# OF GRADE 10 STUDENTS TOOK ONE OR MORE AP EXAMS (SCHOOL)" = "NUMBER OF STUDENTS WHO TOOK ONE ORE MORE AP EXAMS GRADE 10",
  "# OF AP EXAMS TAKEN BY GRADE 11 STUDENTS (SCHOOL)" = "TOTAL AP EXAMS GRADE 11",
  "# OF AP EXAMS PASSED BY GRADE 11 STUDENTS (SCHOOL)" = "TOTAL AP EXAMS RESULTING IN COLLEGE CREDIT GRADE 11",
  "# OF GRADE 11 STUDENTS TOOK ONE OR MORE AP EXAMS (SCHOOL)" = "NUMBER OF STUDENTS WHO TOOK ONE ORE MORE AP EXAMS GRADE 11",
  "# OF GRADE 11 STUDENTS PASSED ONE OR MORE AP EXAMS (SCHOOL)" = "NUMBER OF STUDENTS WHO PASSED ONE ORE MORE AP EXAMS GRADE 11",
  "# OF AP EXAMS TAKEN BY GRADE 12 STUDENTS (SCHOOL)" = "TOTAL AP EXAMS GRADE 12",
  "# OF AP EXAMS PASSED BY GRADE 12 STUDENTS (SCHOOL)" = "TOTAL AP EXAMS RESULTING IN COLLEGE CREDIT GRADE 12",
  "# OF GRADE 12 STUDENTS TOOK ONE OR MORE AP EXAMS (SCHOOL)" = "NUMBER OF STUDENTS WHO TOOK ONE ORE MORE AP EXAMS GRADE 12",
  "# OF GRADE 12 STUDENTS PASSED ONE OR MORE AP EXAMS (SCHOOL)" = "NUMBER OF STUDENTS WHO PASSED ONE ORE MORE AP EXAMS GRADE 12"
  )

rc18 %>% filter(grepl("City of Chicago", `DISTRICT NAME`)) %>% dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")), -contains("IEP"), -contains("TWO OR MORE"), -contains("OTHER"), -contains("ALASKA"), -contains("NUMBER EL"), -contains(" - SUBREGION"), -contains(" - DISTRICT"))
```

```{r}
rc18 <- rc18 %>% filter(grepl("City of Chicago", `DISTRICT NAME`)) %>% 
  dplyr::select(id_info, matches(paste(rc_key_phrases,collapse="|")), -contains("IEP"), -contains("TWO OR MORE"), -contains("OTHER"), -contains("ALASKA"), -contains("NUMBER EL"), -contains(" - SUBREGION"), -contains(" - DISTRICT"))
```

#### Identify and address any missed key columns 
```{r include=FALSE}
# check for column name changes from previous years
setdiff(colnames(full_term), colnames(rc18))
```

```{r include=FALSE}
# check for newly introduced columns in 2018
setdiff(colnames(rc18), colnames(full_term))
```

```{r}
full_term <- plyr::rbind.fill(full_term, rc18)
```

#### Import 2013 and 2014 School Year Report Cards
```{r}
# import years stored in SAS files
rc13 <- haven::read_sas(here::here("data", "rc13-sas-data", "rc13-sas-data.sas7bdat"))
rc14 <- haven::read_sas(here::here("data", "rc14-sas-data", "rc14-sas-data.sas7bdat"))
```

```{r}
# dim(rc13 %>% filter(grepl("City of Chicago", DistNAME)))
# dim(rc14 %>% filter(grepl("City of Chicago", DistNAME)))
```

```{r}
rc13 <- rc13 %>% filter(grepl("City of Chicago", DistNAME))
rc14 <- rc14 %>% filter(grepl("City of Chicago", DistNAME))
rc13 <- mutate(rc13, YEAR = "2013")
rc14 <- mutate(rc13, YEAR = "2014")
```


```{r}

rc13 <- rc13 %>% rename("SCHOOL ID (R-C-D-T-S)" = "SchRcdts",
                "SCHOOL TYPE NAME" = "SchTYPENAME",
                "GRADES IN SCHOOL" = "GRSINSch",
                "SCHOOL NAME" = "SchNAME",
                "DISTRICT NAME" = "DistNAME",
                "SCHOOL - WHITE %" = "SchWhPct", 
                "SCHOOL - BLACK %" = "SchBlPct",
                "SCHOOL - HISPANIC %" = "SchHispPct",
                "SCHOOL - ASIAN %" = "SchAsiPct",
                "SCHOOL TOTAL ENROLLMENT"  = "SchTotEnroll",
                "LOW-INCOME SCHOOL %" = "LowIncSchPct",
                "TOTAL SCHOOL DAYS - SCHOOL" = "TotSchDAYSSch",
                "ATTENDANCE RATE SCHOOL %  -  ALL" = "AttendRATESchPctALL",
                "ATTENDANCE RATE SCHOOL %  -  MALE" = "AttendRATESchPctMALE",
                "ATTENDANCE RATE SCHOOL %  -  FEMALE" = "AttendRATESchPctFem",
                "ATTENDANCE RATE SCHOOL %  -  WHITE" = "AttendRATESchPctWh",
                "ATTENDANCE RATE SCHOOL %  -  HISPANIC" = "AttendRATESchPctHisp",
                "ATTENDANCE RATE SCHOOL %  -  BLACK" = "AttendRATESchPctBl",
                "ATTENDANCE RATE SCHOOL %  -  ASIAN" = "AttendRATESchPctAsi",
                "CHRONIC TRUANTS # - SCHOOL" = "CHRONICTRUANTSNumSch",
                "CHRONIC TRUANTS RATE SCHOOL %" = "CHRONICTRUANTSRATESchPct",
                "DROPOUT RATE  SCHOOL %" = "DROPOUTRATESchPct",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  ALL" = "HS5YrGRADRATESchPctALL",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  ALL" = "HS4YrGRADRATESchPctALL",
                "AVG CLASS SIZE - SCHOOL (KG)" = "AVGCLASSSIZESchKG",
                "AVG CLASS SIZE - SCHOOL (GR1)" = "AVGCLASSSIZESchGR1",
                "AVG CLASS SIZE - SCHOOL (GR2)" = "AVGCLASSSIZESchGR2",
                "AVG CLASS SIZE - SCHOOL (GR3)" = "AVGCLASSSIZESchGR3",
                "AVG CLASS SIZE - SCHOOL (GR4)" = "AVGCLASSSIZESchGR4",
                "AVG CLASS SIZE - SCHOOL (GR5)" = "AVGCLASSSIZESchGR5",
                "AVG CLASS SIZE - SCHOOL (GR6)" = "AVGCLASSSIZESchGR6",
                "AVG CLASS SIZE - SCHOOL (GR7)" = "AVGCLASSSIZESchGR7",
                "AVG CLASS SIZE - SCHOOL (GR8)" = "AVGCLASSSIZESchGR8",
                "AVG CLASS SIZE - SCHOOL (H.S.)" = "AVGCLASSSIZESchHS",
                "OVERALL AVERAGE CLASS SIZE - SCHOOL" = "OVERALLAvgCLASSSIZESch",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  MALE" = "HS4YrGRADRATESchPctMALE",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HS4YrGRADRATESchPctFem",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HS4YrGRADRATESchPctWh",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HS4YrGRADRATESchPctBl",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HS4YrGRADRATESchPctHisp",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HS4YrGRADRATESchPctAsi",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  LOW INCOME" = "HS4YrGRADRATESchPctLowInc",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  MALE" = "HS5YrGRADRATESchPctMALE",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HS5YrGRADRATESchPctFem",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HS5YrGRADRATESchPctWh",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HS5YrGRADRATESchPctBl",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HS5YrGRADRATESchPctHisp",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HS5YrGRADRATESchPctAsi",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  LOW INCOME" = "HS5YrGRADRATESchPctLowInc")

rc14 <- rc14 %>%  rename("SCHOOL ID (R-C-D-T-S)" = "SchRcdts",
                "SCHOOL TYPE NAME" = "SchTYPENAME",
                "GRADES IN SCHOOL" = "GRSINSch",
                "SCHOOL NAME" = "SchNAME",
                "DISTRICT NAME" = "DistNAME",
                "SCHOOL - WHITE %" = "SchWhPct", 
                "SCHOOL - BLACK %" = "SchBlPct",
                "SCHOOL - HISPANIC %" = "SchHispPct",
                "SCHOOL - ASIAN %" = "SchAsiPct",
                "SCHOOL TOTAL ENROLLMENT"  = "SchTotEnroll",
                "LOW-INCOME SCHOOL %" = "LowIncSchPct",
                "TOTAL SCHOOL DAYS - SCHOOL" = "TotSchDAYSSch",
                "ATTENDANCE RATE SCHOOL %  -  ALL" = "AttendRATESchPctALL",
                "ATTENDANCE RATE SCHOOL %  -  MALE" = "AttendRATESchPctMALE",
                "ATTENDANCE RATE SCHOOL %  -  FEMALE" = "AttendRATESchPctFem",
                "ATTENDANCE RATE SCHOOL %  -  WHITE" = "AttendRATESchPctWh",
                "ATTENDANCE RATE SCHOOL %  -  HISPANIC" = "AttendRATESchPctHisp",
                "ATTENDANCE RATE SCHOOL %  -  BLACK" = "AttendRATESchPctBl",
                "ATTENDANCE RATE SCHOOL %  -  ASIAN" = "AttendRATESchPctAsi",
                "CHRONIC TRUANTS # - SCHOOL" = "CHRONICTRUANTSNumSch",
                "CHRONIC TRUANTS RATE SCHOOL %" = "CHRONICTRUANTSRATESchPct",
                "DROPOUT RATE  SCHOOL %" = "DROPOUTRATESchPct",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  ALL" = "HS5YrGRADRATESchPctALL",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  ALL" = "HS4YrGRADRATESchPctALL",
                "AVG CLASS SIZE - SCHOOL (KG)" = "AVGCLASSSIZESchKG",
                "AVG CLASS SIZE - SCHOOL (GR1)" = "AVGCLASSSIZESchGR1",
                "AVG CLASS SIZE - SCHOOL (GR2)" = "AVGCLASSSIZESchGR2",
                "AVG CLASS SIZE - SCHOOL (GR3)" = "AVGCLASSSIZESchGR3",
                "AVG CLASS SIZE - SCHOOL (GR4)" = "AVGCLASSSIZESchGR4",
                "AVG CLASS SIZE - SCHOOL (GR5)" = "AVGCLASSSIZESchGR5",
                "AVG CLASS SIZE - SCHOOL (GR6)" = "AVGCLASSSIZESchGR6",
                "AVG CLASS SIZE - SCHOOL (GR7)" = "AVGCLASSSIZESchGR7",
                "AVG CLASS SIZE - SCHOOL (GR8)" = "AVGCLASSSIZESchGR8",
                "AVG CLASS SIZE - SCHOOL (H.S.)" = "AVGCLASSSIZESchHS",
                "OVERALL AVERAGE CLASS SIZE - SCHOOL" = "OVERALLAvgCLASSSIZESch",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  MALE" = "HS4YrGRADRATESchPctMALE",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HS4YrGRADRATESchPctFem",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HS4YrGRADRATESchPctWh",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HS4YrGRADRATESchPctBl",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HS4YrGRADRATESchPctHisp",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HS4YrGRADRATESchPctAsi",
                "HS 4-YEAR GRAD RATE SCHOOL %  -  LOW INCOME" = "HS4YrGRADRATESchPctLowInc",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  MALE" = "HS5YrGRADRATESchPctMALE",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  FEMALE" = "HS5YrGRADRATESchPctFem",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  WHITE" = "HS5YrGRADRATESchPctWh",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  BLACK" = "HS5YrGRADRATESchPctBl",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  HISPANIC" = "HS5YrGRADRATESchPctHisp",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  ASIAN" = "HS5YrGRADRATESchPctAsi",
                "HS 5-YEAR GRAD RATE SCHOOL %  -  LOW INCOME" = "HS5YrGRADRATESchPctLowInc")


```



```{r}
setdiff(sapply(colnames(rc13), toupper), sapply(colnames(rc14), toupper))
```

#### Remove Extraneous Columns not Renamed
```{r}
# double-check "COMING SOON" columns are all NA in 2013 data
rc13 %>% dplyr::select(contains("Coming")) %>% summarise_all(funs(n_distinct(.)))
```


```{r}
# double-check "COMING SOON" columns are all NA in 2014 data
rc14 %>% dplyr::select(contains("Comming")) %>% summarise_all(funs(n_distinct(.)))
```


```{r}
# remove columns with non-pertinent info
rc13 <- rc13 %>%  dplyr::select(-contains("Coming"), -contains("PctOFStudsNOTTAKING"), -contains("Nhopi"), -contains("TomR"), -contains("StaPct"), -contains("DistPct"), -contains("EnrollFORGR"), -contains("DistGR"), -contains("DistEnroll"),-contains("NumSta"), -contains("StaEnroll"), -contains("Subr"), -contains("MINPERDAY"), -contains("DistDOLLAR"), -contains("EnrollIN"), -contains("ISAT"), -contains("DistBELOW"), -contains("DistMeet"), -contains("Distexceed"), -contains("DistAcadWarn"), -contains("StaBELOW"), -contains("StaMeet"), -contains("Staexceed"), -contains("StaAcadWarn"),  -contains("SCORE"), -contains("SchAcadWarn"), -contains("SchBELOW"), -contains("SchMeet"), -contains("Schexceed"), -contains("PROGRESSING"), -contains("ATTEMPTING"),-contains("FORMeetAND"), -contains("ATTAINING"), -contains("EMERGING"), -contains("PROFICIENT"), -contains("BASIC"), -contains("ADVANCED"), -contains("ParticipatRATE"), -contains("MAKINGAYP"), -contains("Readtest"), -contains("TAKINGMATHTESTS"), -contains("OTHERINDICATO"), -contains("IMPROVEMENT"), -contains("DOLLAR"), -contains("EXPEND"), -contains("SchSINTHESta"), -contains("DistSINTHESta"), -contains("SchSINTHEDist"), -contains("PctMult"), -contains("PctNhopi"), -contains("PctNat"), -contains("ACTCOMP"), -contains("LEGISLATIVE"), -contains("IEP"), -contains("AVGCLASSSIZESta"), -contains("AVGCLASSSIZEDist"), -one_of("ROE","COUNTYCODE","DISTRICT","TYPE", "DistWhPct", "DistBlPct", "DistHispPct", "DistAsiPct", "DistNhopiPct", "DistNatPct", "DistTomRPct", "DistTotEnroll", "StaWhPct", "StaBlPct", "StaHispPct", "StaAsiPct", "StaNhopiPct", "StaNatPct", "StaTomRPct", "StaTotEnroll", "TotSchDAYSDist", "TotSchDAYSSta", "PctREADYFORCollCoursesDist",  "PctREADYFORCollCoursesSta") )


rc14 <- rc14 %>% dplyr::select(-contains("Coming"), -contains("PctOFStudsNOTTAKING"), -contains("Nhopi"), -contains("TomR"), -contains("StaPct"), -contains("DistPct"), -contains("EnrollFORGR"), -contains("DistGR"), -contains("DistEnroll"),-contains("NumSta"), -contains("StaEnroll"), -contains("Subr"), -contains("MINPERDAY"), -contains("DistDOLLAR"), -contains("EnrollIN"), -contains("ISAT"), -contains("DistBELOW"), -contains("DistMeet"), -contains("Distexceed"), -contains("DistAcadWarn"), -contains("StaBELOW"), -contains("StaMeet"), -contains("Staexceed"), -contains("StaAcadWarn"),  -contains("SCORE"), -contains("SchAcadWarn"), -contains("SchBELOW"), -contains("SchMeet"), -contains("Schexceed"), -contains("PROGRESSING"), -contains("ATTEMPTING"),-contains("FORMeetAND"), -contains("ATTAINING"), -contains("EMERGING"), -contains("PROFICIENT"), -contains("BASIC"), -contains("ADVANCED"), -contains("ParticipatRATE"), -contains("MAKINGAYP"), -contains("Readtest"), -contains("TAKINGMATHTESTS"), -contains("OTHERINDICATO"), -contains("IMPROVEMENT"), -contains("DOLLAR"), -contains("EXPEND"), -contains("SchSINTHESta"), -contains("DistSINTHESta"), -contains("SchSINTHEDist"), -contains("PctMult"), -contains("PctNhopi"), -contains("PctNat"), -contains("ACTCOMP"), -contains("LEGISLATIVE"), -contains("IEP"), -contains("AVGCLASSSIZESta"), -contains("AVGCLASSSIZEDist"), -one_of("ROE","COUNTYCODE","DISTRICT","TYPE", "DistWhPct", "DistBlPct", "DistHispPct", "DistAsiPct", "DistNhopiPct", "DistNatPct", "DistTomRPct", "DistTotEnroll", "StaWhPct", "StaBlPct", "StaHispPct", "StaAsiPct", "StaNhopiPct", "StaNatPct", "StaTomRPct", "StaTotEnroll", "TotSchDAYSDist", "TotSchDAYSSta", "PctREADYFORCollCoursesDist",  "PctREADYFORCollCoursesSta") )



```




```{r}
full_term <- plyr::rbind.fill(full_term, rc13, rc14)

saveRDS(full_term, file = here::here("data", "full_term.Rda"))
# 
```


#### PDF-Scraping: Retrieve School Ward Numbers 
```{r}
library(tm)
read <- tm::readPDF(control = list(text = "-layout"))
schoolsByWard <- Corpus(URISource(here::here("data", "Schools_by_Ward_2012.pdf")), readerControl = list(reader = read))
schoolsByWard_content <- content(schoolsByWard[[1]])
schoolsByWard_content <- unlist(schoolsByWard_content <- strsplit(schoolsByWard_content, "\n"))
```

```{r}
page_breaks <- grep("02/05/2019", schoolsByWard_content)
schoolsByWard_content <- schoolsByWard_content[- (page_breaks)]
```

```{r}
# Remove headers
header_rows <- grep("^Schools by", schoolsByWard_content) 

schoolsByWard_content <- schoolsByWard_content[- (header_rows)]

subtitle_rows <- grep("^Based on", schoolsByWard_content) 
schoolsByWard_content <- schoolsByWard_content[- (subtitle_rows)]
```

```{r}
# add delimiters to PDF text corpus
schoolsByWard <-  gsub(" {2,100}", ";", schoolsByWard_content)
```

```{r}
# Concatenate cut-off rows
to_remove <- list()

for (i in 1:length(schoolsByWard)) {
  if (str_count(schoolsByWard[i],";") == 3 ) {
    schoolsByWard[[i]] = gsub("Ave ", "Ave;", schoolsByWard[[i]])
    schoolsByWard[[i]] = gsub("Blvd ", "Blvd;", schoolsByWard[[i]])
    
  } else if (str_count(schoolsByWard[i],";") < 3 ) {
    if (";Dr" %in% schoolsByWard[[i]] | ";Ave" %in% schoolsByWard[[i]]) {
      schoolsByWard[[i]] = paste(str_match(schoolsByWard[i-1], '^(?:[^;]*;){3}([^;]*)'), " ", gsub(";", "", schoolsByWard[[i]]), ";", str_match(schoolsByWard[i-1], '(?:[^;]*;){0}([^;]*)$'), sep="")[1]
      to_remove <- append(to_remove, i-1)
      
    } else {
    schoolsByWard[[i]] = paste(str_match(schoolsByWard[[i-1]], '^(?:[^;]*;){2}([^;]*)'), " ", gsub(";", "", str_match(schoolsByWard[[i]],'(?:[^;]*;)([^;][:alpha:]+[:space:]*){1,4}')), ";", str_match(schoolsByWard[[i-1]], '(?:[^;]*;){1}([^;]*)$'), sep="")[1]
    to_remove <- append(to_remove, i-1)
    }
  }
}

schoolsByWard <- schoolsByWard[-(unlist(to_remove))]
```



```{r}
schoolsByWard <-  read.table(text=schoolsByWard, sep=";", quote="", stringsAsFactors=FALSE, header = TRUE)
schoolsByWard <- schoolsByWard %>% dplyr::select(-one_of('X'))

saveRDS(schoolsByWard, file = here::here("data", "schoolsByWard.Rda"))

```


## Import CPS Budget Files
```{r}
formatBudget <- function(budget_df, year) {
  df_names <- colnames(budget_df)
  for (i in 1:length(df_names)) {
    
    if (str_detect(df_names[i], as.character(year))) {
       df_names[i] <-  gsub(paste("FY ",year," ", sep=""),"", df_names[i])
       df_names[i] <-  gsub(paste("FY",year," ", sep=""),"", df_names[i])
    } else if (str_detect(df_names[i], as.character(year - 1))) {
      df_names[i] <- gsub(paste("FY ",year - 1," ", sep=""),"Previous Year ", df_names[i])
      df_names[i] <- gsub(paste("FY",year - 1," ", sep=""),"Previous Year ", df_names[i])
    } else if (str_detect(df_names[i], as.character(year - 2))) {
      df_names[i] <- gsub(paste("FY ",year - 2," ", sep=""),"2 Yr Prior ", df_names[i])
      df_names[i] <- gsub(paste("FY",year - 2," ", sep=""),"2 Yr Prior ", df_names[i])
    } 
    
    if (str_detect(df_names[i], "Difference of")) { 
      df_names[i] <- str_match(df_names[i], "(.)+Difference")[1] 
      }
    if ((df_names[i] == "Budget") || (df_names[i] == "Positions") ) { 
      df_names[i] <- str_c(df_names[i], " Difference") 
      }
  } 
  return(df_names)
}
```


```{r warning=FALSE}
compileBudgets <- function(filename, year, col_types=c("guess", "guess", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric")) {
  
  budget_df <- read_xlsx(here::here("data", filename), col_names = TRUE, skip = 2,
                        col_types = col_types)
  budget_df <- budget_df %>% mutate(unitNum = gsub("U", "", Unit),
                                    YEAR=year)
  colnames(budget_df) <- formatBudget(budget_df, year)
  return(budget_df)
 }
```

#### Import 2013-2019 School Budgets from CPS
```{r warning=FALSE}


bud13 <- compileBudgets("FY12-13 My Schools Report by Category by Unit RollUp.xlsx", 2013, col_types=c("guess", "guess", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))
bud14 <- compileBudgets("FY12-14 My Schools Report by Category by Unit RollUp.xlsx", 2014)
bud15 <- compileBudgets("FY13-15 My Schools Report by Category by Unit RollUp.xlsx", 2015)
bud16 <- compileBudgets("FY14-16 My Schools Report by Category by Unit RollUp.xlsx", 2016)
bud17 <- compileBudgets("FY15-17 My Schools Report by Category by Unit RollUp.xlsx", 2017, col_types=c("guess", "guess", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"))
bud18 <- compileBudgets("FY16-18 My Schools Report by Category by Unit RollUp.xlsx", 2018)
bud19 <- compileBudgets("FY18-19 My Schools Report by Category by Unit RollUp.xlsx", 2019)
```



```{r}
all_budgets <- plyr::rbind.fill(bud13, bud14, bud15, bud16, bud17, bud18, bud19)

```


```{r}
all_budgets <- all_budgets %>% mutate(`Proposed Budget` = ifelse(is.na(`Proposed Budget`), `Approved Budget`, `Proposed Budget`),
                                      `Proposed Positions` = ifelse(is.na(`Proposed Positions`), `Approved Positions`, `Proposed Positions`))
# rm(bud13, bud14, bud15, bud16, bud17, bud18, bud19)
saveRDS(all_budgets, file = here::here("data", "all_budgets.Rda"))
# 
```


```{r include=FALSE, eval=FALSE}
# look at rows missing budget difference
all_budgets %>% filter(is.na(`Budget Difference`))
```



```{r}
scraped_CPS_ids <- read_csv(here::here('data_preparation', 'data', 'CPS_ids.csv'), col_names = TRUE)
```

```{r}
ISBE_school_list <- read_xls(here::here('data_preparation', 'data', 'dir_ed_entities.xls'), col_names = TRUE, sheet = "Public Dist & Sch")
```

```{r}
ISBE_school_list %>% filter(grepl("299", `Region-2
County-3
District-4`)) %>% filter(City!="Chicago")
```
```{r}
Chicago_ISBE_list <- ISBE_school_list %>% filter(grepl("299", `Region-2
County-3
District-4`))
```


```{r}
Chicago_ISBE_list <- left_join(Chicago_ISBE_list, scraped_CPS_ids, by=c("FacilityName"="ISBE_FacilityName"))
```

```{r}
Chicago_ISBE_list <- Chicago_ISBE_list %>% mutate(RCDTS_ID = paste(`Region-2
County-3
District-4`, Type, School, sep = ""))
```


```{r}
all_report_cards <-  readRDS(here::here("data", "full_term.Rda"))
```



```{r}
all_report_cards_both_ids <- left_join(all_report_cards, Chicago_ISBE_list, by=c("SCHOOL ID (R-C-D-T-S)"="RCDTS_ID"))
```


```{r message=FALSE}
# read in file with IDs to join from different sources
id_overlap <- read_csv(here::here("data_preparation","data", "Chicago_Public_Schools_-_School_Profile_Information_SY1617.csv"), col_names = TRUE)
id_overlap18 <- read_csv(here::here("data_preparation", "data", "NEW_Chicago_Public_Schools_-_School_Profile_Information_SY1718.csv"), col_names = TRUE)
id_overlap <- id_overlap %>% mutate(Finance_ID = as.character(Finance_ID))
id_overlap18 <- id_overlap18 %>% mutate(Finance_ID = as.character(Finance_ID))
# saveRDS(id_overlap, file = here::here("data", "id_overlap.Rda"))


```


```{r}
left_join(all_report_cards_both_ids,  id_overlap %>% dplyr::select('School_ID','Finance_ID'), by=c("CPS_id_num"="School_ID")) %>% filter(is.na(Finance_ID))
```
```{r}
all_report_cards_both_ids <- left_join(all_report_cards_both_ids,  id_overlap %>% dplyr::select('School_ID','Finance_ID'), by=c("CPS_id_num"="School_ID"))
```

```{r}
dim(all_report_cards_both_ids)
```


```{r}
all_budgets <-  readRDS(here::here("data", "all_budgets.Rda"))
```


```{r}
all_budgets <- all_budgets %>% mutate(YEAR = as.numeric(YEAR))
all_report_cards_both_ids <- all_report_cards_both_ids  %>% mutate(YEAR = as.numeric(YEAR))

school_data <- left_join(all_report_cards_both_ids, all_budgets, by = c("Finance_ID" = "unitNum", "YEAR" = "YEAR"), na_matches="never")

```


```{r}

schoolsByWard <-  readRDS(here::here("data_preparation", "data", "schoolsByWard.Rda"))


schoolsByWard <- schoolsByWard %>% rename("School_ID" =  "School.ID", 
                      "Unit_Name" = "Name.of.School",
                      "Address" = "Street.Address")

```



```{r}
# confirm all rows matched to a budget have "Proposed Budget column"
# 43 rows do not have budget
school_data %>% filter(!is.na(CPS_id_num) & is.na(`Proposed Budget`))

  
# add ward to rows from schoolsByWard document parsed above
school_data <- left_join(school_data, schoolsByWard %>% dplyr::select(School_ID, WARD = Ward, NAME_WARD_JOIN = `Unit_Name`), by=c("CPS_id_num" = "School_ID"), na_matches="never") %>% dplyr::select(CPS_id_num, WARD, SCHOOL_NAME = `SCHOOL NAME`, NAME_WARD_JOIN, `Proposed Budget`, `SCHOOL TOTAL ENROLLMENT`, everything())

```



```{r message=FALSE}

# calculate average spend per student
school_data <- school_data %>% 
  mutate(
    # remove commas from enrollment column and make sure it's numeric
    `SCHOOL TOTAL ENROLLMENT` = as.numeric(gsub(",","",`SCHOOL TOTAL ENROLLMENT`)),
    `Proposed Budget` = as.numeric(`Proposed Budget`),
    # calculate a basic average spend based on enrollment and budget for each row
    AVG_SPEND_PER_STUDENT = as.numeric(`Proposed Budget` / as.numeric(gsub(",","",`SCHOOL TOTAL ENROLLMENT`))),
   # ensure year columns are all numeric
   YEAR = as.numeric(YEAR),
   PREV_YR = as.numeric(YEAR) - 1,
   TWO_YR_PRIOR = as.numeric(YEAR) - 2,
   # remove trailing white space from school types column 
   `SCHOOL TYPE NAME` = str_trim(`SCHOOL TYPE NAME`),
   SCHOOL_NAME = str_trim(SCHOOL_NAME),
   # make sure all charter schools are included in school types column
   `SCHOOL TYPE NAME` = ifelse(str_detect(pattern="C$", `SCHOOL ID (R-C-D-T-S)`),
                                "CHARTERSCH", `SCHOOL TYPE NAME`)) %>% 
  dplyr::select(YEAR, PREV_YR, TWO_YR_PRIOR, CPS_id_num, WARD, NAME_WARD_JOIN, 
                CY_BUDGET = `Proposed Budget`, 
                SCHOOL_TOTAL_ENROLLMENT =  `SCHOOL TOTAL ENROLLMENT`,
                AVG_SPEND_PER_STUDENT, everything())

# add Chicago area based on matching generated from Chicago Open Data portal dataset 
# and UChicago community-area-to-Side matching
school_data <- left_join(school_data, read_csv(here::here("data_preparation", "data", "wardSides.csv")),
                         by="WARD") %>% 
  dplyr::select(YEAR, PREV_YR, TWO_YR_PRIOR, CPS_id_num, WARD, SIDE, everything())

    
# make sure all years have all school types
school_data %>% distinct(YEAR, `SCHOOL TYPE NAME`)
```


```{r}
saveRDS(school_data, file = here::here("data_preparation", "data", "combined_school_data.Rda"))
```



```{r fig.height=12, fig.width=15, message=FALSE, warning=FALSE}    
# check whether there are schools which could be matched to ward, that aren't
school_data %>% filter(!is.na(School_Latitude) & is.na(WARD))

st_as_sf(
  # isolate school IDs, geolocation info (address, latitude, longitude)
  school_data %>% 
           dplyr::select(`SCHOOL ID (R-C-D-T-S)`, School_ID, `SCHOOL_NAME`, Address, School_Latitude, School_Longitude), 
         coords = c(School_Latitude, School_Longitude), 
  agr = c(`SCHOOL ID (R-C-D-T-S)` = "identity", 
          CPS_id_num = "identity", 
          `SCHOOL_NAME` = "identity", 
          Address = "constant"))
```



```{r include = FALSE}
monochromatic_C6C3FF <- c(
"#7d77ff",
"#9690ff",
"#aeaaff",
"#c6c3ff",
"#deddff",
"#f6f6ff")

diverging_teal <- c(
                    # 'navy' = '#2d3d61',
                    'darkteal' = '#2d4f5a',
                    'forest' = '#2d615f',
                    'plankton' = '#2d706e',
                    'ocean' = '#318791',
                    'mauve' = '#996768',
                    'cocoa' = '#b5725a',
                    'honeymustard' = '#d59349',
                    'goldenrod' = '#edb834',
                    'darkgray' = '#B5B5B5',
                    'palegray' = '#E5E5E5')

```



```{r include=FALSE}
# make it easy to select colors by name, thanks Dr. Simon J!
# Attribution: https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2
get_dt_cols <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (diverging_teal)
  diverging_teal[cols]
}
```

```{r include=FALSE}
# set groupings of colors as palettes
dt_palettes <- list(
  `main`  = get_dt_cols("ocean", "mauve", "darkteal", "goldenrod"),
  `diverging` = get_dt_cols("darkteal", "goldenrod", "forest", "honeymustard", "ocean", "mauve"),
  `cool`  = get_dt_cols("darkteal", "forest", "plankton", "ocean"),
  `desert`   = get_dt_cols("mauve", "goldenrod", "cocoa", "honeymustard"),
  `mixed` = get_dt_cols("mauve", "ocean", "honeymustard", "forest", "cocoa", "plankton", "honeymustard"),
  `grey`  = get_dt_cols("palegray", "darkgray")
)
```


```{r}
# function for uilitizing palettes
dt_pal <- function(palette = "main", reverse = FALSE, shift=0,...) {
  pal <- dt_palettes[[palette]]
  
    if (shift > 0) {
    pal = pal[1+shift:length(pal)]
  }
  
  if (reverse) pal <- rev(pal)
  
  # pass alpha, other color arguments to colorRampPalette
  colorRampPalette(pal, ...)
}

# function for applying palettes to borders and fills in ggplot2
scale_color_dt <- function(palette = "main", discrete = TRUE, reverse = FALSE, shift=0, ...) {
  pal <- dt_pal(palette = palette, reverse = reverse, shift=shift)
  
  if (discrete) {
    discrete_scale("colour", paste0("dt_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), guide="colourbar", ...)
  }
}

scale_fill_dt <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- dt_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("dt_", palette), palette = pal, guide="colourbar", ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}
```


```{r}
theme_modest <- function(base_size = 16,
                                  base_family = "Roboto",
                                  base_line_size = base_size / 25,
                                  base_rect_size = base_size / 25) {
  require(grid)
  theme_minimal(base_size = base_size, 
                base_family = base_family,
                base_line_size = base_line_size)  %+replace%
    theme(
        axis.title = element_text(size = rel(0.75)),
        axis.title.y = element_text(margin=unit(c(0,0,0,2),"lines"), size=rel(1.25)),
        axis.title.x = element_text(margin=unit(c(2,0,0,0), "lines")),
        axis.text = element_text(size = rel(0.75)),
        axis.ticks=element_line(colour="grey", size=0.5),
        panel.grid.major = element_line(colour="grey", size=0.4),
        panel.grid.minor = element_line(colour="lightgrey", size=0.25),
        legend.box = NULL, 
        legend.title = element_text(size = rel(1)),
        legend.text = element_text(size = rel(0.5)),
        legend.key.height = NULL,
        legend.key.width = NULL,
        legend.key.size = unit(20, "pt"),
        legend.key = element_rect(fill = NA, colour = NA),
        legend.background = element_rect(colour = NA, fill=NA), 
        legend.position = "right",
        legend.justification = "center", 
        plot.background = element_rect(colour = NA, fill="#fffbe6"),
        plot.margin = unit(c(3,3,3,3),"lines"),
        plot.title = element_text(face = "bold", hjust="0.5",
                                  margin =unit(c(0,0,1,0), "lines"), family="Ledger"),
        plot.subtitle = element_text(size = rel(0.9), hjust="0.5",  
                                     margin = unit(c(0,0,2,0), "lines"), family="Ledger"),
        plot.caption = element_text(size = rel(0.75), hjust = 1, 
                                    margin = unit(c(2,0,0,0), "lines")),
        strip.background = element_rect(colour = NA, fill=NA),
        strip.text = element_text(face = "bold", size = rel(0.65), family = "Ledger"),
        panel.spacing = unit(15,"lines"),
        panel.border=element_blank(),
        complete = TRUE
    )
}
  
  

theme_map_modest <- function(base_size = 12) {
  require(grid)
  theme_modest(base_size) %+replace%
    theme(
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text = element_blank(),
        axis.ticks=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.border=element_blank(),
        panel.spacing = unit(0,"lines"),
        plot.margin  =  unit(c(10,10,10,10),"lines")
    )
}

theme_set(theme_modest(base_size = 12))
```


```{r fig.height=12, fig.width=15, message=FALSE, warning=FALSE}

  ggplot(school_data) +
  # geom_line(aes(x=AVG_SPEND_PER_STUDENT, y=as.factor(YEAR))) +
  geom_point(aes(x=AVG_SPEND_PER_STUDENT, y=as.factor(YEAR), 
                 color=SIDE, size=SCHOOL_TOTAL_ENROLLMENT)) +
  scale_size_continuous(range = c(6,10)) +
    scale_color_dt(na.value=get_dt_cols("palegray")) +
  theme_modest() +
  theme(legend.text = element_text(size=rel(1)),
        legend.title = element_text(size=rel(1))) 
```




```{r fig.height=12, fig.width=15, message=FALSE, warning=FALSE}
library(ggridges)
library(cowplot)

school_data %>%        
  ggplot(aes(x = AVG_SPEND_PER_STUDENT, y = as.factor(YEAR))) +
      geom_density_ridges( mapping = aes(x = AVG_SPEND_PER_STUDENT,
                            y = as.factor(YEAR), color=predominant_race, 
                            size=3), fill=NA) +
  scale_color_dt("diverging", reverse = TRUE, na.value=get_dt_cols("palegray")) +
    scale_x_continuous(labels = scales::dollar, limits=c(0,20000)) + 
  theme_modest() + 
  labs(title = "2018 School Funding Update Increased Spread of Annual Spend per Student", fontface='bold')
```


 

```{r fig.height=12, fig.width=15, message=FALSE, warning=FALSE}
facet_sides_labels <- as_labeller(c(`Far North` = "Far North Side", 
                   `Far Southeast` = "Far Southeast Side",
                   `Far Southwast` = "Far Southwast Side",
                   North = "North Side",
                   Northwest= "Northwest Side",
                   South = "South Side",
                   Southwest = "Southwest Side",
                   West = "West Side",
                   `NA` = "Side Unavailable"))

#                                       
# 
# facet_sides_labels2 <- c("Far North" = "Far North Side", 
#                    "Far Southeast" = "Far Southeast Side",
#                    "Far Southwast" = "Far Southwast Side",
#                    "North" = "North Side",
#                    "Northwest"= "Northwest Side",
#                    "South" = "South Side",
#                    "Southwest" = "Southwest Side",
#                    "West" = "West Side",
#                    "NA" = "Side Information Not Available") 
#  
# 
# 
both_plots <- plot_grid(
school_data %>%
  ggplot(aes(x = AVG_SPEND_PER_STUDENT, y = as.factor(YEAR))) +
      geom_density_ridges( mapping = aes(x = AVG_SPEND_PER_STUDENT,
                            y = as.factor(YEAR), fill=predominant_race)) +
  scale_fill_dt(reverse = TRUE, na.value=get_dt_cols("palegray")) +
    scale_x_continuous(labels = scales::dollar, limits=c(0,20000)) +
  theme_modest(),
NULL,
  school_data %>%
ggplot(aes(x = AVG_SPEND_PER_STUDENT, y = as.factor(YEAR))) +
      geom_density_ridges(
                          mapping = aes(x = AVG_SPEND_PER_STUDENT,
                            y = as.factor(YEAR), fill=predominant_race) ) +
  scale_fill_dt("main", reverse = TRUE, na.value=get_dt_cols("palegray")) +
    scale_x_continuous(labels = scales::dollar) +
  theme_modest() +
  facet_wrap(SIDE ~ ., labeller = facet_sides_labels),
ncol = 1, rel_heights =  c(1, 0.1, 1), align = 'v')

title <- ggdraw() + draw_label("2018 School Funding Update Increased Spread of Annual Spend per Student", fontface='bold', size=50)
plot_grid(title, both_plots, ncol=1, rel_heights=c(0.1, 1))
```




```{r fig.height=12, fig.width=15}
school_data %>% 
  filter(!is.na(SPEND_RANGE)) %>%
  ggplot(aes(SPEND_RANGE)) +
  # geom_line(aes(y=AVG_SPEND_PER_STUDENT, x=YEAR)) +
  geom_bar(aes(group=as.factor(predominant_race), fill=predominant_race)) +
    scale_fill_dt(na.value=get_dt_cols("palegray")) +

  theme_modest() +
  theme(legend.text = element_text(size=rel(1)),
        legend.title = element_text(size=rel(1))
        ) +
  facet_wrap(~YEAR)
```




```{r  fig.height=12, fig.width=15,  message=FALSE, warning=FALSE}

school_data %>% group_by(YEAR, predominant_race, ENROLLMENT_RANGE) %>% summarise(median_spend = median(AVG_SPEND_PER_STUDENT)) %>%
  ggplot(aes(x=median_spend, y=ENROLLMENT_RANGE, group=as.factor(predominant_race))) +
  geom_point(aes(color=SIDE), position="jitter",size=6) +
    scale_color_dt(na.value=get_dt_cols("palegray")) +
  theme_modest() +
  theme(legend.text = element_text(size=rel(1)),
        legend.title = element_text(size=rel(1))) +
  facet_wrap(~YEAR)
```



```{r fig.height=12, fig.width=15}
school_data %>% 
  group_by(YEAR, predominant_race) %>% 
  summarise(median_class_size = mean(as.integer(`OVERALL AVERAGE CLASS SIZE - SCHOOL`), na.rm=TRUE),
            num_schools = n()) %>%
  ggplot() +
  geom_line(aes(x=as.numeric(YEAR), y=median_class_size, group=as.factor(predominant_race), color=predominant_race)) +
    scale_color_dt(na.value=get_dt_cols("palegray")) +
  theme_modest() +
  theme(legend.text = element_text(size=rel(1)),
        legend.title = element_text(size=rel(1)))
```

