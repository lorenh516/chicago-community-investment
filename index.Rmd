---
title: "Chicago Community Investment Exploration"
author: Loren Hinkson
output:
    html_document:
      df_print: paged
      code_folding: hide
---

```{r Housekeeping, echo=TRUE, message=FALSE, warning=FALSE, include=FALSE}
# Housekeeping (clear workspace, start output file, load packages)
# rm(list=ls())

# data cleaning, augmenting, manipulation
library(tidyverse)
library(dplyr)
library(haven)
# library(stargazer)
library(xtable)
library(readxl)
# library(astsa)
library(Hmisc)
library(tidycensus)
library(lubridate)
library(here)

# plotting tools
library(gridExtra)
library(ggplot2)
library(grid)
library(ggrepel)
library(gghighlight)
library(ggalt)
library(scales)
library(extrafont)
# font_import()
# loadfonts()
library(swatches)
library(ggbeeswarm)

# mapping tools
library(raster)
library(rgdal)
library(rgeos)
library(maptools)
library(tigris)
library(ggmap)
library(sf)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```


```{r include = FALSE}
monochromatic_C6C3FF <- c(
"#7d77ff",
"#9690ff",
"#aeaaff",
"#c6c3ff",
"#deddff",
"#f6f6ff")

diverging_teal <- c(
                    # 'navy' = '#2d3d61',
                    'darkteal' = '#2d4f5a',
                    'forest' = '#2d615f',
                    'plankton' = '#2d706e',
                    'ocean' = '#318791',
                    'mauve' = '#996768',
                    'cocoa' = '#b5725a',
                    'honeymustard' = '#d59349',
                    'goldenrod' = '#edb834',
                    'darkgray' = 'B5B5B5',
                    'palegray' = '#E5E5E5')

```



```{r include=FALSE}
# make it easy to select colors by name, thanks Dr. Simon J!
# Attribution: https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2
get_dt_cols <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (diverging_teal)
  diverging_teal[cols]
}
```

```{r include=FALSE}
# set groupings of colors as palettes
dt_palettes <- list(
  `main`  = get_dt_cols("ocean", "mauve", "darkteal", "goldenrod"),
  `diverging` = get_dt_cols("darkteal", "goldenrod", "forest", "honeymustard", "ocean", "mauve"),
  `cool`  = get_dt_cols("darkteal", "forest", "plankton", "ocean"),
  `desert`   = get_dt_cols("mauve", "goldenrod", "cocoa", "honeymustard"),
  `mixed` = get_dt_cols("mauve", "goldenrod", "darkteal", "forest", "cocoa", "plankton", "honeymustard"),
  `grey`  = get_dt_cols("palegray", "darkgray")
)
```


```{r include=FALSE}
# function for uilitizing palettes
dt_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- dt_palettes[[palette]]
  if (reverse) pal <- rev(pal)
  # pass alpha, other color arguments to colorRampPalette
  colorRampPalette(pal, ...)
}

# function for applying palettes to borders and fills in ggplot2
scale_color_dt <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- dt_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("colour", paste0("dt_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

scale_fill_dt <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- dt_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("dt_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}
```


```{r set_theme, message=FALSE, warning=FALSE, include=FALSE}
theme_modest <- function(base_size = 16,
                                  base_family = "Roboto",
                                  base_line_size = base_size / 25,
                                  base_rect_size = base_size / 25) {
  require(grid)
  theme_minimal(base_size = base_size, 
                base_family = base_family,
                base_line_size = base_line_size)  %+replace%
    theme(
        axis.title = element_text(size = rel(0.75)),
        axis.title.y = element_text(margin=unit(c(0,0,0,2),"lines")),
        axis.title.x = element_text(margin=unit(c(2,0,0,0), "lines")),
        axis.text = element_text(size = rel(0.75)),
        axis.ticks=element_line(colour="grey", size=0.5),
        panel.grid.major = element_line(colour="grey", size=0.4),
        panel.grid.minor = element_line(colour="lightgrey", size=0.25),
        legend.box = NULL, 
        legend.title = element_text(size = rel(1)),
        legend.text = element_text(size = rel(0.5)),
        legend.key.height = NULL,
        legend.key.width = NULL,
        legend.key.size = unit(20, "pt"),
        legend.key = element_rect(fill = NA, colour = NA),
        legend.background = element_rect(colour = NA, fill=NA), 
        legend.position = "right",
        legend.justification = "center", 
        plot.background = element_rect(colour = NA, fill="#fffbe6"),
        plot.margin = unit(c(3,3,3,3),"lines"),
        plot.title = element_text(size = rel(1), face = "bold", hjust="0.5",
                                  margin =unit(c(0,0,1,0), "lines"), family="Ledger"),
        plot.subtitle = element_text(size = rel(0.75), hjust="0.5",  
                                     margin = unit(c(0,0,2,0), "lines"), family="Ledger"),
        plot.caption = element_text(size = rel(0.75), hjust = 1, 
                                    margin = unit(c(2,0,0,0), "lines")),
        strip.background = element_rect(colour = NA, fill=NA),
        strip.text = element_text(face = "bold", size = rel(0.75), family = "Ledger"),
        panel.spacing = unit(15,"lines"),
        panel.border=element_blank(),
        complete = TRUE
    )
}
  
  

theme_map_modest <- function(base_size = 12) {
  require(grid)
  theme_modest(base_size) %+replace%
    theme(
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text = element_blank(),
        axis.ticks=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.border=element_blank(),
        panel.spacing = unit(0,"lines"),
        plot.margin  =  unit(c(10,10,10,10),"lines")
    )
}

theme_set(theme_modest(base_size = 12))
```


```{r import-licenses, message=FALSE, warning=FALSE, include=FALSE}
# import business licenses data
# bus_licenses <- read_csv(here::here("data", "Business_Licenses.csv"))
bus_licenses <-  readRDS(here::here("data", "bus_licenses.Rda"))
bus_licenses <- bus_licenses %>% mutate(SIDE = ifelse(SIDE == "Far Southwest", "Far Southwest Side",
                                               ifelse(SIDE == "Far Southeast", "Far Southeast Side", SIDE)))


# view problems report
# problems(bus_licenses)


# investigate nonstandard zip codes flagged -- looks like int'l businesses operating in Chicago
# opting not not to remove
# bind_cols(bus_licenses[unlist(problems(bus_licenses)[, 'row']), c('LICENSE ID', 'LEGAL NAME', 'DOING BUSINESS AS NAME', 'ADDRESS', 'CITY', 'STATE', 'BUSINESS ACTIVITY')], problems(bus_licenses)[, 'actual']) %>% arrange(ADDRESS) %>% distinct(`DOING BUSINESS AS NAME`, `BUSINESS ACTIVITY`, ADDRESS, CITY, STATE, actual)
```


```{r add-lic-cols, include=FALSE}
# add columns for 
# bus_licenses <- mutate(bus_licenses, 
#                        active=ifelse(grepl("AAI",`LICENSE STATUS`),1,0),
#                        app_review = difftime(mdy(`LICENSE APPROVED FOR ISSUANCE`,tz="America/Chicago"), mdy(`APPLICATION REQUIREMENTS COMPLETE`,tz="America/Chicago"),unit="days"),
#                        license_term = difftime(mdy(`LICENSE TERM EXPIRATION DATE`,tz="America/Chicago"), mdy(`LICENSE TERM START DATE`,tz="America/Chicago"),unit="days"),
#                        activity_date = mdy(ifelse(is.na(`LICENSE STATUS CHANGE DATE`), `DATE ISSUED`, `LICENSE STATUS CHANGE DATE`),tz="America/Chicago"),
                      # activity_month = lubridate::as_date(
                      #  cut(activity_date, breaks = "month", start.on.monday = FALSE, origin = lubridate::origin)
                      #  ),
#                        activity_yr = lubridate::year(activity_date)
#                        )
```


```{r include=FALSE}
# wardSides <- read_csv(here::here("data", "wardSides.csv"))
```



```{r, include=FALSE}
# bus_licenses <- bus_licenses %>% mutate(activity_wk = lubridate::as_date(cut(activity_date, breaks = "week", start.on.monday = FALSE, origin = lubridate::origin)))
# bus_licenses <- left_join(bus_licenses, wardSides, by="WARD")
# saveRDS(bus_licenses, file = here::here("data", "bus_licenses.Rda"))
```


```{r pre-2015-lic, include=FALSE, eval=FALSE}
# data exploration
bus_licenses %>% group_by(activity_date, WARD) %>% summarise(business_count = n()) %>% 
  filter(activity_date < mdy("1/1/2015"), !is.na(WARD)) %>%
  ggplot() + geom_line(aes(x=activity_date, y=business_count, colour=as.factor(WARD))) +
  gghighlight(min(business_count), max_highlight = 3L) +
  labs(y="Business Count", x="Activity Date", colour="Ward", 
       title="Chicago Ward Business Presence", 
       caption="Data Source: Chicago Open Data Portal") + 
  theme_modest() + 
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_color_dt() 
```

```{r check-2012-spike, include=FALSE}
# look into spike around beginning of 2013
# bus_licenses %>% group_by(activity_date, WARD) %>% summarise(bus_count = n()) %>% summarise(max_activity = max(bus_count)) %>% arrange(desc(max_activity))
```

```{r pre-2015-licensing, echo=FALSE, include=FALSE}
# bus_licenses %>% filter(active==1, activity_date < mdy("1/1/2015"), !is.na(WARD), !(activity_date== mdy("12/29/2012"))) %>%
#   group_by(activity_date, WARD) %>% summarise(business_count = n()) %>% 
#   ggplot() + geom_line(aes(x=activity_date, y=business_count, colour=as.factor(WARD))) +
#   gghighlight(min(business_count), max_highlight = 3L) +
#   labs(y="Business Count", x="Activity Date", colour="Ward", 
#        title="Chicago Ward Business Presence (2002-2015)", 
#        caption="Data Source: Chicago Open Data Portal") + 
#   theme_modest() + 
#   theme(panel.grid.major.x = element_blank(),
#         panel.grid.minor = element_blank()) +
#   scale_color_dt() 
```


```{r save-pre-2015-licensing, include=FALSE}
# ggsave("pre_2015_licensing.pdf", width = 30, height = 15, units = "cm")
```




```{r import-former-wards, include=FALSE}
# wardsPre2015 <- sf::st_read(here::here("data","Geofiles - Chicago Zip Code and Neighborhood", "Boundaries - Wards (2003-2015)","geo_export_fa687596-87b6-4059-afac-b28ce789a674.shp"))
# 
# wardsPre2015 <-wardsPre2015 %>% mutate(lon=map_dbl(geometry, ~st_centroid(.x)[[1]]), # add centroid values for labels
#                                     lat=map_dbl(geometry, ~st_centroid(.x)[[2]])) # add centroid values for labels
```




```{r include=FALSE}
# run API key
tidycensus::census_api_key(Sys.getenv("CENSUS_API_KEY"))

# cache census shapefiles
# tigris_cache_dir(here::here("data", "tigris_cache"))
# options(tigris_use_cache = TRUE)
# readRenviron('~/.Renviron')
```


```{r  include=FALSE}
# want to know: how population changing/ not changing across tracts - race, age, income, poverty status, safety net takeup
getDemos <- function(acs_year, geoms=TRUE) {
  tidycensus::get_acs(geography = "tract", 
              variables = c(medianIncome = 'B19013_001',
                            perCapitaIncome = 'B19301_001',
                            population = 'B02001_001',
                            belowPovertyPop = 'B17001_002',
                            whitePop = 'B02001_002',
                            blackPop = 'B02001_003',
                            latinxPop = 'B03001_003',
                            asianPop = 'B02001_005',
                            citizenshipPop = 'B05001_001',
                            naturalized = 'B05001_005',
                            noncitizen = 'B05001_006',
                            mobilityPop = 'B07001_001',
                            movedInsideCounty = 'B07001_033',  #hipster age movement inside Cook County
                            movedInside20to24 = 'B07001_021',  #hipster age movement inside Cook County
                            movedInside25to29 = 'B07001_022', 
                            medAgemovedInside = 'B07002_003',
                            renterPop = 'B07013_001',
                            owners = 'B07013_002',
                            renters = 'B07013_003',
                            transportPop = 'B08122_001',
                            publicTransport = 'B08122_013',
                            households = 'B22001_001',
                            householdsSNAP = 'B22001_002',
                            householdsKidsSNAP = 'B22002_003',
                            kidsHealthIns = 'B27001_007',
                            medicarePop = 'C27006_001',
                            maleChildMedicare = 'C27006_004',
                            maleMedicare18_64 = 'C27006_007',
                            maleMedicare65_up = 'C27006_010',
                            femaleMedicare18_64 = 'C27006_017',
                            femaleMedicare65_up = 'C27006_020',
                            femaleChildMedicare = 'C27006_014',
                            medicaidPop = 'C27007_001',
                            maleChildMedicaid = 'C27007_004',
                            maleMedicaid18_64 = 'C27007_007',
                            maleMedicaid65_up = 'C27007_010',
                            femaleMedicaid18_64 = 'C27007_017',
                            femaleMedicaid65_up = 'C27007_020',
                            femaleChildMedicaid = 'C27007_014'
                            ), 
              year = acs_year,
              state = 17, # IL = 17
              county = 031, # Cook County = 031 FIPS
              geometry = geoms)
}
```


```{r  include=FALSE}

demoConversion <- function(acs_year, geoms = TRUE) {
  demo_df <- getDemos(acs_year=acs_year, geoms)
  demo_df <- demo_df %>% dplyr::select(-one_of("moe")) %>% spread(variable, estimate)
  demo_df <- demo_df %>% mutate(
                      asian_pct = asianPop/ population,
                      black_pct = blackPop / population,
                      latinx_pct = latinxPop/ population,
                      white_pct = whitePop/ population,
                      other_pct = ifelse(
                        (population - blackPop - latinxPop - whitePop - asianPop) / population > 0, 
                        (population - blackPop - latinxPop - whitePop - asianPop) / population, 
                        NA),
                      below_poverty_pct = belowPovertyPop / population,
                      childMedicaid_pct = (femaleChildMedicaid + maleChildMedicaid) / medicarePop,
                      childMedicare_pct = (femaleChildMedicare + maleChildMedicare) / medicarePop,
                      takeupMedicare_pct = (maleChildMedicare + maleMedicare18_64 + maleMedicare65_up +
                          femaleChildMedicare + femaleMedicare18_64 + femaleMedicare65_up) / medicarePop,
                      takeupMedicaid_pct = (maleChildMedicaid + maleMedicaid18_64 + maleMedicaid65_up +
                          femaleChildMedicaid + femaleMedicaid18_64 + femaleMedicaid65_up) / medicaidPop,
                      households_kidsSNAP_pct = householdsKidsSNAP / households,
                      takeupSNAP_pct = householdsSNAP / households,
                      YAmovesInChi_pct = (movedInside20to24 + movedInside25to29) / mobilityPop,
                      movesInChi_pct = movedInsideCounty / mobilityPop,
                      immigrant_pct = (naturalized + noncitizen) / citizenshipPop,
                      renting_pct = renters / renterPop,
                      public_transport_pct = publicTransport / transportPop
                      ) %>% 
    dplyr::select(GEOID, NAME, medianIncome, perCapitaIncome, population, medAgemovedInside, contains("_pct"), everything())
  
    demo_df <- left_join(demo_df, as.data.frame(demo_df) %>% 
                           dplyr::select(GEOID, NAME, black_pct, 
                                         latinx_pct, asian_pct, 
                                         white_pct, other_pct) %>%
                           group_by(GEOID, NAME) %>% 
                           gather(group_name, pct, -GEOID, -NAME) %>% 
                           slice(which.max(pct)) %>% 
                           mutate(
                             predominant_race = ifelse(
                             group_name == 'black_pct', 'Black',
                             ifelse(group_name == 'white_pct', 'White',
                             ifelse(group_name == 'asian_pct', 'Asian',
                             ifelse(group_name == 'latinx_pct', 'Latinx',
                             ifelse(group_name == 'other_pct', 'Other')))))) %>% 
                           dplyr::select(GEOID, NAME, predominant_race, max_pct = pct), 
                         by = c("GEOID", "NAME")
                       )
    return(demo_df)
}
```


```{r echo=TRUE, include=FALSE, eval=FALSE}
# test that census calls working
getDemos(2017)
```



```{r message=FALSE,  include = FALSE, eval=FALSE}
years <- list(2012, 2013, 2014, 2015, 2016, 2017)
multi_year <-
  map(.x = years, .f=demoConversion, geoms=TRUE) %>%
  map2(.y = years, ~ mutate(.x, id = .y))

all_demos <- reduce(multi_year, rbind)
# all_demos_range <- reduce(multi_year, rbind)

# match census sf object to Chicago wards projection
all_demos <-st_transform(all_demos, crs =  st_crs(wards.2015))

saveRDS(all_demos, file = here::here("data", "all_demos_chi_proj.Rda"))
```


```{r fortify-mapping, message=FALSE, include=FALSE, eval=FALSE}

# wards.2015 <- sf::st_read(here::here("data","Geofiles - Chicago Zip Code and Neighborhood","Boundaries - Wards (2015-)","geo_export_0bb2e9fd-20ca-415b-a96a-7722d72c1b41.shp"))
```

```{r  include=FALSE, eval=FALSE}

# 
# all_demos_range <-st_transform(all_demos_range, crs =  st_crs(wards.2015))




# add centroid values for labels
# wards.2015 <- wards.2015  %>% mutate(long=map_dbl(geometry, ~st_centroid(.x)[[1]]), # add centroid values for labels
#                                                       lat=map_dbl(geometry, ~st_centroid(.x)[[2]]))
# wards.2015 <- merge(wards.2015, read_csv(here::here("data", "wardSides.csv")))

# saveRDS(wards.2015, file = here::here("data", "wards2015_sf.Rda"))

# limit Census data to tracts within Chicago ward boundaries
# # all.demos.Chi <- st_intersection(all_demos, wards.2015.acs.proj)
# colnames(all_demos)

# wards_w_demos <- st_join(wards.2015, all_demos_range)

```


In the last decade, underrepresented minority populations in Chicago have been increasingly relegated to lower income areas in the South and West of the City. 
```{r facet_wrap_demo_info, message=FALSE, warning=FALSE, fig.width=10, fig.height=15, eval=FALSE}

# 
# all_demos <- readRDS(here::here("data", "all_demos_chi_proj.Rda"))
# 
wards.2015 <-  readRDS(here::here("data", "wards2015_sf.Rda"))
all_demos <-  readRDS(here::here("data", "all_demos_chi.Rda"))

selected_demos <- all_demos %>% filter(id %in% c(2012, 2015, 2017))

wards_selected_demos <- st_join(wards.2015, 
                                st_transform(selected_demos, crs = st_crs(wards.2015))
                                )
# agr = c(
#  "GEOID" = "identity", "NAME" = "identiy", "id"="identity", "medianIncome" = "aggregate", 
#  "perCapitaIncome" = "aggregate", "population" = "aggregate", "medAgemovedInside" = "aggregate",  
#  "asian_pct" = "aggregate", "black_pct" = "aggregate", "latinx_pct" = "aggregate", "white_pct" = "aggregate",
#  "other_pct" = "aggregate", "below_poverty_pct" = "aggregate", "childMedicaid_pct" = "aggregate", 
#  "childMedicare_pct" = "aggregate", "takeupMedicare_pct" = "aggregate",  "takeupMedicaid_pct" = "aggregate",
#  "households_kidsSNAP_pct"="aggregate", "takeupSNAP_pct" = "aggregate", "YAmovesInChi_pct" = "aggregate", 
#  "movesInChi_pct" = "aggregate", "immigrant_pct" = "aggregate", "renting_pct" = "aggregate", 
#  "public_transport_pct" = "aggregate", "asianPop" = "aggregate", "belowPovertyPop" = "aggregate", 
#  "blackPop" = "aggregate", "citizenshipPop" = "aggregate", "femaleChildMedicaid" = "aggregate", 
#  "femaleChildMedicare" = "aggregate", "femaleMedicaid18_64" = "aggregate", "femaleMedicaid65_up" = "aggregate",
#  "femaleMedicare18_64"  = "aggregate", "femaleMedicare65_up" = "aggregate", "households" = "aggregate",
#  "householdsKidsSNAP","householdsSNAP" = "aggregate", "kidsHealthIns" = "aggregate", "latinxPop" = "aggregate",
#  "maleChildMedicaid" = "aggregate",  "maleChildMedicare" = "aggregate", "maleMedicaid18_64" = "aggregate",
#  "maleMedicaid65_up" = "aggregate", "maleMedicare18_64" = "aggregate", "maleMedicare65_up" = "aggregate",
#  "medicaidPop" = "aggregate", "medicarePop" = "aggregate", "mobilityPop" = "aggregate", 
#  "movedInside20to24" = "aggregate", "movedInside25to29" = "aggregate", "movedInsideCounty" = "aggregate", 
#  "naturalized" = "aggregate", "noncitizen" = "aggregate", "owners" = "aggregate", 
#  "publicTransport" = "aggregate", "renterPop" = "aggregate", "renters" = "aggregate", "transportPop" = "aggregate", "whitePop" = "aggregate",  "predominant_race" = "aggregate", "max_pct" = "aggregate"    
# )

# plot intersection of Census tracts with chicago wards
ggplot(wards_selected_demos) +
  # color based on predominant race based on Census, shaded by percentage of that race
  geom_sf(aes(fill=medianIncome), lwd = 0) +
  scale_fill_dt("diverging", discrete=FALSE, na.value=get_dt_cols("palegrey")) +
  scale_alpha(range = c(0.15, 1), guide="none") + 
  
  # outline Chicago wards over data
  geom_sf(data = wards.2015, color="black", fill=NA) +
  
  # label wards with the most movement
  # geom_text_repel(data=wards.2015 %>% filter(ward %in% c(10, 18)), 
  #                 aes(x=long, y=lat, label=ward),
  #                 fontface="bold",
  #                 force = 5,
  #                 size = 6,
  #                 direction = "both",
  #                 hjust=0) +
  # geom_text_repel(data=wards.2015 %>% filter(ward %in% c(9, 13, 14, 33, 34)), 
  #                 aes(x=long, y=lat, label=ward),
  #                 nudge_x = -.35,
  #                 segment.size = 0.5,
  #                 segment.color = get_dt_cols("cocoa"),
  #                 fontface="bold",
  #                 size = 6,
  #                 force = 5,
  #                 direction = "both",
  #                 hjust=0) +
  # geom_text_repel(data = wards.2015 %>% filter(ward %in% c(11)), 
  #                 aes(x=long, y=lat, label=ward),
  #                 nudge_x = .15,
  #                 segment.size = 0.5,
  #                 segment.color = get_dt_cols("cocoa"),
  #                 fontface="bold",
  #                 size = 6,
  #                 force = 10,
  #                 direction = "both",
  #                 hjust = 1) +
  coord_sf(datum = NA) +
  theme_map_modest() + 
  theme(plot.margin = unit(c(20, 0, 0, 0), "pt"),
        plot.title = element_text(face = "bold", hjust="0.5", margin = margin(t = 15)),
        plot.subtitle = element_text( margin = margin(t = 15)),
        plot.caption = element_text(hjust=1)) +
  
  # plot each year separately
  facet_wrap( ~ id) + labs(
    title = "Latinx Populations in Chicago\nPushed to South, West Neighborhoods",
    subtitle = "Chicago Racial and Ethnic Group Movement\nby Census Tract Since 2012 (5 year averages)",
    caption = "Data Source: U.S. Census Bureau", fill = "Predominant Race in Tract")
  

```

```{r include=FALSE, eval=FALSE}
# all_demos <-  readRDS(here::here("data", "all_demos_chi.Rda"))

# wards_w_all_demos <- st_join(wards.2015, st_transform(all_demos, crs =  st_crs(wards.2015)), largest=TRUE)

wards_w_all_demos %>% filter(YEAR %in% c(2012, 2015, 2017)) %>%
  ggplot() + 
    geom_sf(aes(fill=medianIncome), alpha=0.5) + 
  scale_fill_dt("cool", discrete=FALSE, reverse=TRUE, na.value=get_dt_cols("palegray")) +
  geom_sf(aes(color=predominant_race), fill=NA, lwd=3) +
  scale_color_dt("diverging", discrete=TRUE, na.value=get_dt_cols("palegray"))  +
  theme_map_modest() +
  facet_wrap(~YEAR)
```



```{r save-bus-locs, warning=FALSE, include = FALSE, eval=FALSE}
ggsave("ward_demographics.pdf", width = 30, height = 25, units = "cm")
```

## Business Activity by Chicago Side Over Time
```{r bus-stagnation-bar, fig.height=12, fig.width=15, message=FALSE, warning=FALSE}

all_wards_all_dates <-  readRDS(here::here("data", "all_wards_all_dates.Rda"))

allDatesCount.df <- all_wards_all_dates %>% expand(SIDE_CLEAN, WARD, `APPLICATION TYPE`, count_date) %>% 
 full_join(all_wards_all_dates) %>%  arrange(SIDE_CLEAN, WARD, `APPLICATION TYPE`, count_date) %>% 
  mutate(
    activity_wk = lubridate::as_date(
      cut(count_date, breaks = "week", start.on.monday = FALSE, origin = lubridate::origin)),
   activity_month = lubridate::as_date(
      cut(count_date, breaks = "month", start.on.monday = FALSE, origin = lubridate::origin)),
   activity_qtr = lubridate::as_date(
      cut(count_date, breaks = "quarter", start.on.monday = FALSE, origin = lubridate::origin)) 
   )


library(lemon)
allDatesCount.df %>% 
  filter(`APPLICATION TYPE` %in% c("ISSUE", "RENEW")) %>% group_by(SIDE, activity_qtr, `APPLICATION TYPE`) %>% 
  summarise(active_businesses = sum(active_businesses)) %>% 
  arrange(activity_qtr, desc(active_businesses), SIDE) %>%
 mutate(SIDE_CLEAN = factor(SIDE,levels = rev(unique(SIDE))),
        SIDE_CLEAN = ifelse(SIDE_CLEAN == "Far Southwest", "Far Southwest Side", 
                     ifelse(SIDE_CLEAN == "Far Southeast", "Far Southeast Side",
                     SIDE_CLEAN))) %>%
              ggplot(aes(x=activity_qtr, y=active_businesses)) +   
  geom_bar(aes(x=activity_qtr, y=active_businesses, fill=`APPLICATION TYPE`), stat = "identity", position="dodge", show.legend = FALSE) +
  scale_fill_dt() +
  # geom_text(aes(label=active_businesses), 
  #           size = 3, position = position_stack(vjust = 0.5), color="white") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_date(date_labels = "%b %y", 
                date_breaks = "1 year", limits = c(ymd("2012-01-01"), ymd("2018-12-31"))) +
  theme_modest() + 
  theme(legend.position = c(0.6, 0.9),
        legend.direction = "horizontal",
        legend.key.size = unit(25, "pt"),
        legend.title = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.spacing = unit(2, "lines"),
        strip.text = element_text(family="Ledger"),
        axis.title.y = element_text(size=rel(1.5), margin=unit(c(0,3,0,0),"lines"), angle=90, family="Ledger"),
        axis.text.x = element_text(hjust = 0, angle=-45),
        axis.title.x = element_blank(),
        plot.margin = unit(c(2,4,2,2),"lines")) + facet_rep_wrap(~ SIDE_CLEAN, repeat.tick.labels=TRUE) +
      labs(y="Number of Business Licenses Issued or Renewed", colour="Chicago Council Ward", caption="Data Source: Chicago Open Data Portal",  title="New Business Never Returns to Far Southeast and Far Southwest Post-Recession", subtitle = "Steady decline in new business entry post-recession in Chicago areas with lowest economic activity pre-recession", fill="Chicago Area")  
  # annotate("text", x=lubridate::ymd("2013-01-01"), y = 850000, label="Business renewals dipping in 2013, were balanced by spikes in new business due to EDGE tax credits.")
```
Immediately post-recession in 2013, the amount of [Economic Development for a Growing Economy (EDGE) tax credits granted by Illinois nearly doubled from the prior year](https://www.chicagobusiness.com/article/20171006/NEWS02/171009915/corporate-tax-incentives-back-in-favor-in-illinois), causing a brief spike in new business issuances for every area of the city beyond Central (Loop area), which has experienced fairly constant new business entry since the recession. Thus far, only the West Side of Chicago is approaching 2012 levels of new business, with most other areas of the city remaining fairly constant after EDGE excitement tapered off. In the Far Southeast and Far Southwest Sides, where ecnomic activity (in terms of number of active businesses) was about half the next lowest areas even pre-taper, one must wonder how much growth a neighborhood can experience with a rate of new business entry that has hovered around 500 businesses operating on newly-issued licenses for months. For contrast, the mean number of quarterly new licenses issued in the Central area of the city is just under 700,000, and the mean number of quarterly licenses issued in the Northwest Side is jsut over 85,000.

```{r include=FALSE, echo=TRUE, eval=FALSE}
# to look into: relationship between population and new business, can talk about that here. esp. number of new businesses per capita could be more meaningful than raw numbers.
# Also potentially interesting: population in far SE and far SW also going down?

allDatesCount.df %>% 
  filter(`APPLICATION TYPE` %in% c("ISSUE", "RENEW")) %>% group_by(SIDE, activity_qtr, `APPLICATION TYPE`) %>% 
  summarise(active_businesses = sum(active_businesses)) %>% 
  group_by(SIDE, `APPLICATION TYPE`) %>% 
  summarise(min_ct = min(active_businesses),
            median_ct = median(active_businesses),
            mean_ct = mean(active_businesses, na.rm=TRUE),
            max_ct = max(active_businesses))
```


## Mapping Chicago's Forgotten Economies
```{r ggmapping, message=FALSE, warning=FALSE, fig.height=17, fig.width=15, include=FALSE, eval=FALSE}



# read in Chicago ward geos in ggmap-compatible format
wards.shp.2015 <- here::here("data","Geofiles - Chicago Zip Code and Neighborhood","Boundaries - Wards (2015-)","geo_export_0bb2e9fd-20ca-415b-a96a-7722d72c1b41.shp")
wards2015 <- shapefile(wards.shp.2015)
wards2015@data <- mutate(wards2015@data, id = rownames(wards2015@data))
wards2015.points <- fortify(wards2015, region="id")
wards2015.df <- merge(wards2015.points, wards2015@data, by="id")



# name license types
license_types <- c("ISSUE" = "New Business Licenses", 
                   "RENEW" = "Business License Renewals")  

# filter for 2012+ issuances and licenses 
# count each business only once per year)
bl <- bus_licenses %>% filter(activity_yr >= 2012, active == 1, `APPLICATION TYPE`%in% c('ISSUE', 'RENEW')) %>% 
    distinct(`LICENSE ID`, activity_yr, `APPLICATION TYPE`, LONGITUDE, LATITUDE) 
  


# ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
#   geom_point(alpha = 0.7, show.legend = FALSE) +
#   scale_colour_manual(values = country_colors) +
#   scale_size(range = c(2, 12)) +
#   scale_x_log10() +
#   facet_wrap(~continent) +
#   # Here comes the gganimate specific bits
#   labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
#   transition_time(year) +
#   ease_aes('linear')

# pull in Chicago terrain map from Google Maps
  ggmap::ggmap(ggmap::get_googlemap(center = c(lon = -87.732125, lat = 41.83379),
                      zoom = 10, scale = 1,
                      maptype ='terrain',
                      color = 'color',
                      key = Sys.getenv("GOOGLEMAPS_KEY"))) + 
    ggplot(data=bl, aes(x=LONGITUDE, y=LATITUDE, color=as.factor(activity_yr))) +
    # layer licenses over each other at extremely low alpha
    geom_point(data=bl, aes(x=LONGITUDE, y=LATITUDE, color=as.factor(activity_yr)), alpha = 0.05, show.legend = FALSE, na.rm = TRUE) + 
    
    # add Chicago Ward boundaries
    geom_path(data = wards2015.df, aes(long,lat,group=group), color="black") +
    geom_polygon(data = wards2015.df, aes(long,lat,group=group), fill=NA) + 
    scale_color_dt() +
    labs(y="Latitude", x="Longitude", colour="Year", title="Money in the Middle", 
         subtitle="Virtually No New Business Entry, Renwal in South, Far Southeast,\nFar Southwest Sides since 2012", 
         caption = "Data Source: City of Chicago Department of Business Affairs and Consumer Protection"
         ) +
    theme_modest() + 
    facet_grid(. ~ `APPLICATION TYPE`, labeller=as_labeller(license_types)) +
    theme(
      panel.border = element_blank(),
      axis.text.y = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      plot.title = element_text(face = "bold", hjust="0.5", margin = margin(t = 15)),
      plot.subtitle = element_text(hjust="0.5", margin = margin(t = 20))
    ) +
    
    # zoom graph to outer ward boundaries
    scale_x_continuous(limits = c(wards2015.df %>% dplyr::select(long) %>% min() - 0.1, wards2015.df %>% dplyr::select(long) %>% max() + 0.05), expand = c(0, 0)) +
    scale_y_continuous(limits = c(wards2015.df %>% dplyr::select(lat) %>% min() - 0.1, wards2015.df %>% dplyr::select(lat) %>% max()) + 0.05, expand = c(0, 0))
```



```{r include=FALSE, eval=FALSE}
ggsave("location_over_googlemap_zoom10.pdf", width = 36, height = 23, units = "cm")
```




```{r avg-monthly-lic, warning=FALSE, fig.width=15, fig.height=12, message=FALSE}
# filter for business license issuances and renewals, and create a monthly count
bus_licenses %>% filter(!is.na(WARD), active==1,  activity_date >= mdy("1/1/2012")) %>%
  group_by(activity_month, activity_yr, WARD, SIDE) %>% 
  summarise(business_count = n()) %>% group_by(WARD, SIDE) %>% arrange(desc(business_count)) %>% 
  
  # plot boxplot of median monthly issuances and renewals for each ward
  ggplot(aes(x=reorder(reorder(reorder(SIDE, business_count, FUN = median),WARD),business_count, FUN=median), y=business_count)) + 
  # add comparison line for lowest levels of montly ward business activity
  geom_hline(yintercept=25, linetype = "dotted") +
  # draw boxplots with color and order determined by Chicago Side area
  geom_boxplot(aes(group=reorder(as.factor(WARD), SIDE), fill=as.factor(SIDE)), show.legend = FALSE) + 
  scale_fill_dt() +
  
  # label each each box by corresponding Ward, just above the median (8 pt)
  # geom_text_repel(data = bus_licenses %>% filter(!is.na(WARD), active==1) %>%
  #                   group_by(activity_month, activity_yr, WARD, SIDE) %>% 
  #                   summarise(business_count = n()) %>% group_by(SIDE) %>% 
  #                   arrange(desc(business_count)) %>% 
  #                   summarise(median_issuances = median(business_count)) %>% 
  #                   arrange(median_issuances),
  #                  aes(x=as.factor(SIDE), y = median_issuances + 300, group=as.factor(SIDE),
  #                      label=as.factor(SIDE), nudge_x=0.05, direction= "y"),
  #           color="#6E2C49", fontface="bold", size=5, hjust=0.5) + 
  
  # limit scale to 750, (one Loop ward's outliers extend ~1000 above other wards)
  # still very clearly the highest even without all outliers visible
  scale_y_continuous(breaks = sort(c(seq(0, 750, by=150))), limits = c(0, 750)) +
  labs(x="Chicago Council Ward", y="Average Monthly Business Count", caption="Data Source: Chicago Open Data Portal", title="Least New & Surviving Businesses in Far South,\nSouthwest Wards for 5+ Years", subtitle="Since 2012, Far South wards average 26 or less monthly business license issuances and renewals",fill="Chicago Area") + 
  theme_modest() +
  theme(
        panel.grid.major.x = element_blank(),
        axis.ticks =  element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text( family="Ledger", size=rel(0.60)),
        axis.text.y = element_text( margin=unit(c(0,2,2,2), "lines")),
        axis.title.y = element_text(margin=unit(c(0,0,2,2), "lines"), size=rel(0.85), angle = 90, family = "Ledger"),
        plot.caption = element_text(hjust=1)
        ) +
  annotate("text", x = 7 , y= 370, label="Most West Side business\noccurs in Wards 2 and 27,\nwhich border the Loop.", size=rel(4)) +
  annotate("text", x = 9 , y= 735, label="The Central area is comprised\nof Ward 42, the Loop area.", size=rel(4)) +
  annotate("text", x = 5 , y= 315, label="South Side business activity\nis concentrated in Kenwood,\n Fuller Park areas bordering\nthe University of Chicago.", size=rel(4)) +
  annotate("text", x = 3 , y= 285, label="Ward 12 on the Southwest\nSide bordering Chinatown is\ncharacterized by higher rates\nof business activity than\nits neighbors.", size=rel(4))
  
```

```{r save-new-bus, warning=FALSE, include=FALSE, eval=FALSE}
ggsave("avg_ward_business.pdf", width = 25, height = 18, units = "cm")
```


```{r include=FALSE, eval=FALSE}
bus_licenses %>% filter(!is.na(WARD), active==1,  activity_date >= mdy("1/1/2012")) %>%
  group_by(activity_month, activity_yr, WARD, SIDE) %>% 
  summarise(business_count = n()) %>% group_by(SIDE, WARD) %>% 
  summarise(med_ward_bus_ct = median(business_count),
            max_ward_bus_ct = max(business_count)) %>% 
  arrange(SIDE, WARD) 
```


## Exploring Voter Activation in Deinvested Wards
```{r message=FALSE, warning=FALSE, include=FALSE}
# read in 2015 turnout data and format columns for numeric manipulations, add column for year

# voter_turnout15 <- read_csv(here::here("data", "voter_turnout_city_council_2015.csv"), col_names = FALSE, skip=8)
# voter_turnout15 <- voter_turnout15 %>% mutate(WARD = ifelse(grepl("WARD", voter_turnout15$X1), as.numeric(gsub("WARD ", "", X1)), NA),
#                                               X4 = as.numeric(gsub("%", "", X4)),
#                                               YEAR = 2015)
# voter_turnout15 <- voter_turnout15 %>% fill(WARD)


# double-check columns that look empty
# voter_turnout15 %>% dplyr::select(X5, X6) %>% distinct()


# filter out subtitles and intermediate headings

# voter_turnout15 <- voter_turnout15 %>% dplyr::select(-c(X5, X6))
# names(voter_turnout15) <- sapply(c("Precinct","Registered","Ballots","Turnout", "WARD", "YEAR"), toupper)
# voter_turnout15 <- voter_turnout15 %>% filter(PRECINCT !="Precinct", !grepl("WARD", PRECINCT), !is.na(PRECINCT))


# read in 2011 turnout data and format columns for numeric manipulations, add column for year

# voter_turnout11 <- read_csv(here::here("data", "voter_turnout_city_council_2011.csv"), col_names = FALSE, skip=8)
# voter_turnout11 <- voter_turnout11 %>% mutate(WARD = ifelse(grepl("WARD", voter_turnout11$X1), as.numeric(gsub("WARD ", "", X1)), NA),
#                                               X4 = as.numeric(gsub("%", "", X4)),
#                                               YEAR=2011)
# voter_turnout11 <- voter_turnout11 %>% fill(WARD)


# double-check columns that look empty
# voter_turnout11 %>% dplyr::select(X5, X6) %>% distinct()


# filter out subtitles and intermediate headings

# voter_turnout11 <- voter_turnout11 %>% dplyr::select(-c(X5, X6))
# names(voter_turnout11) <- sapply(c("Precinct","Registered","Ballots","Turnout", "WARD", "YEAR"), toupper)
# voter_turnout11 <- voter_turnout11 %>% filter(PRECINCT !="Precinct", !grepl("WARD", PRECINCT), !is.na(PRECINCT))


# combine 2011 and 2015 data into one dataset

# voterTurnout <- bind_rows(voter_turnout11, voter_turnout15)
# voterTurnout <- voterTurnout %>% 
#   mutate(TURNOUT = round((as.numeric(gsub(",", "", BALLOTS)) / as.numeric(gsub(",", "", REGISTERED))) * 100,1))
# rm(voter_turnout11, voter_turnout15)


# consolidate turnout and change in turnout by Chicago area

# turnoutSides <- merge(voterTurnout, wardSides, by="WARD") %>% filter(PRECINCT=="Total") %>% 
#   group_by(YEAR, SIDE) %>% summarise(MEAN_TURNOUT = round(mean(TURNOUT, na.rm = TRUE), 1)) %>% 
#   spread(YEAR, MEAN_TURNOUT) %>% mutate(DIFFERENCE = `2015` - `2011`) %>% 
#   gather("YEAR", "TURNOUT", -SIDE, -DIFFERENCE) %>% 
#   mutate(DIFFERENCE = ifelse(YEAR==2011, NA, DIFFERENCE)) %>% 
#   dplyr::select(YEAR, everything()) %>% 
#   arrange(SIDE, YEAR)
# 
# saveRDS(turnoutSides, file = here::here("data", "sides_turnout.Rda"))                                  
 

# consolidate turnout and change in turnout by Chicago ward

# turnoutDiff <- voterTurnout %>%filter(PRECINCT=="Total", YEAR %in% c(2011, 2015)) %>% dplyr::select(WARD, TURNOUT, YEAR) %>% 
#   group_by(YEAR, WARD) %>%
#   spread(YEAR, TURNOUT) %>% mutate(DIFFERENCE = `2015` - `2011`) %>% 
#   gather("YEAR", "TURNOUT", -WARD, -DIFFERENCE) %>% 
#   mutate(DIFFERENCE = ifelse(YEAR==2011, NA, DIFFERENCE)) %>% 
#   dplyr::select(YEAR, WARD, TURNOUT, DIFFERENCE) %>% 
#   arrange(YEAR, WARD) %>% group_by(WARD) %>% merge(., wardSides, by="WARD")

# saveRDS(turnoutDiff, file = here::here("data", "wards_turnout.Rda"))
``` 


```{r slopegraph, fig.height=12, fig.width=15}
# read in turnout and change in turnout by Chicago ward and Chciago Side
  turnoutSides <-  readRDS(here::here("data", "sides_turnout.Rda"))
  turnoutDiff <-  readRDS(here::here("data", "wards_turnout.Rda"))
  
  # turnoutDiff %>% group_by(SIDE, WARD) %>% summarise(z = max(TURNOUT)) %>% filter(SIDE == "Far Southwest")
  
  # plot average turnout in 2011 and 2015 for each Chicago Side
  ggplot(turnoutSides, aes(x=as.factor(YEAR), y=TURNOUT, group=as.factor(SIDE))) + 
  geom_line(aes(colour=SIDE), size=1.5, show.legend = FALSE) +
  # geom_line(data = filter(turnoutSides, (DIFFERENCE > -0)||(is.na(DIFFERENCE))), aes(colour=SIDE), size=1.5, show.legend=FALSE) +
  scale_color_dt() + 
    
  # add lines for distribution within each Side at Ward level
  geom_line(data = turnoutDiff, aes(group=as.factor(WARD), color=SIDE), size=0.5, alpha=0.35, show.legend = FALSE) +
  
  # label each Side's values in line graphs for both 2011 and 2015
  geom_label_repel(data = turnoutSides %>% filter(YEAR == 2011), 
            aes(label = paste0(SIDE, " - ", TURNOUT, "%"), color = SIDE),
            fill=NA,
            hjust = "left",
            nudge_x = -.15,
            force=6,
            direction = "y",
            xlim= c(-0.5,.965),
            fontface = "bold",
            label.size = 0,
            point.padding	= 0.75,
            size = rel(5),
            show.legend = FALSE,
            family="Ledger") +
  geom_label_repel(data = turnoutSides %>% filter(YEAR == 2015),
            aes(label = paste0(SIDE, " - ", TURNOUT, "%"), color = SIDE),
            fill=NA,
            hjust = "right",
            nudge_x = .25,
            force = 5,
            direction = "y",
            fontface = "bold",
            point.padding	= 0.75,
            xlim=c(2.05,3),
            label.size = 0,
            size = rel(5),
            show.legend = FALSE,
            family="Ledger") +
  # move x-axis text to top of graph
  scale_x_discrete(position = "top") +
   # coord_cartesian(ylim=c(23.5, 60)) +
  theme_modest() + 
  theme(axis.text.x.top = element_text(size=rel(1.25), vjust = -8, face="bold"),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.y = element_blank(),
          panel.grid.minor=element_blank(),
          panel.grid.major=element_blank(),
          plot.title = 
        )+
        # plot.subtitle = element_text(hjust=0.35)) +
  labs(title="Amid City-Wide Turnout Dropoff, Significantly Higher\nVoter Activation in Far Southwest Side", 
         subtitle="Voters in the Far Southeast, which has faced de-investment\nas determined by a number of factors, far exceeded other areas' participation\nin the last two City Council elections.", 
         caption="Source: Chicago Board of Election Commissioners", color="Chicago Area") +
  annotate("text",  x = 1, y = 25, label = "*Underlying ward trends visualized\nbehind Side trendlines", size=rel(4)) + 
    annotate("text", x = 0.8, y = 65, label="Ward 19 on the Far Southwest\nSide, which contains the Beverly\nand Morgan Park neighborhoods,\nhad voter turnout of nearly\n75% in the 2011 City Council\nElection.", size=rel(4), hjust=0, color=get_dt_cols("mauve"))
```


```{r include=FALSE}
ggsave("ward_election_turnout2011_2015.pdf", width = 36, height = 23, units = "cm")
```




```{r eval=FALSE, include=FALSE}
# multi_year <-
#   map(.x = years, .f=demoConversion, geoms=FALSE) %>%
#   map2(.y = years, ~ mutate(.x, YEAR = .y))
# 
# just_demos <- reduce(multi_year, rbind) 
# # all_demos_range <- reduce(multi_year, rbind)
# rm(multi_year)

# saveRDS(just_demos, file = here::here("data", "just_demos.Rda"))
```

## Investing in the Future: Signs of Educational De-Investment
```{r quasi-random, fig.height=12, fig.width=15, message=FALSE, warning=FALSE}
# read in combined school report card and budget dataset
school_data <-  readRDS(here::here("data", "combined_school_data.Rda"))

schoolsByWard <-  readRDS(here::here("data", "schoolsByWard.Rda"))



schoolsByWard <- schoolsByWard %>% rename("School_ID" =  "School.ID", 
                      "Unit_Name" = "Name.of.School",
                      "Address" = "Street.Address")

# add ward to rows from schoolsByWard document parsed above
school_data <- left_join(school_data, 
                         schoolsByWard %>% 
                           dplyr::select(School_ID, WARD = Ward, NAME_WARD_JOIN = Unit_Name), 
                         by=c("School_ID" = "School_ID")) %>% 
  dplyr::select(School_ID, WARD, SCHOOL_NAME = `SCHOOL NAME`, 
                NAME_WARD_JOIN, `Proposed Budget`, 
                `SCHOOL TOTAL ENROLLMENT`, everything())

# calculate average spend per student
school_data <- school_data %>% 
  mutate(
    # remove commas from enrollment column and make sure it's numeric
    `SCHOOL TOTAL ENROLLMENT` = as.numeric(gsub(",","",`SCHOOL TOTAL ENROLLMENT`)),
    `Proposed Budget` = as.numeric(`Proposed Budget`),
    # calculate a basic average spend based on enrollment and budget for each row
    AVG_SPEND_PER_STUDENT = as.numeric(`Proposed Budget` / as.numeric(gsub(",","",`SCHOOL TOTAL ENROLLMENT`))),
   # ensure year columns are all numeric
   YEAR = as.numeric(YEAR),
   PREV_YR = as.numeric(YEAR) - 1,
   TWO_YR_PRIOR = as.numeric(YEAR) - 2,
   # remove trailing white space from school types column 
   `SCHOOL TYPE NAME` = str_trim(`SCHOOL TYPE NAME`),
   SCHOOL_NAME = str_trim(SCHOOL_NAME),
   # make sure all charter schools are included in school types column
   `SCHOOL TYPE NAME` = ifelse(str_detect(pattern="C$", `SCHOOL ID (R-C-D-T-S)`),
                                "CHARTERSCH", `SCHOOL TYPE NAME`)) %>% 
  dplyr::select(YEAR, PREV_YR, TWO_YR_PRIOR, School_ID, WARD, NAME_WARD_JOIN, 
                CY_BUDGET = `Proposed Budget`, 
                SCHOOL_TOTAL_ENROLLMENT =  `SCHOOL TOTAL ENROLLMENT`,
                AVG_SPEND_PER_STUDENT, everything())

# add Chicago area based on matching generated from Chicago Open Data portal dataset 
# and UChicago community-area-to-Side matching
school_data <- left_join(school_data, read_csv(here::here("data", "wardSides.csv")),
                         by="WARD") %>% 
  dplyr::select(YEAR, PREV_YR, TWO_YR_PRIOR, School_ID, WARD, SIDE, everything())

    
# make sure all years have all school types
# school_data %>% distinct(YEAR, `SCHOOL TYPE NAME`)

# create variable of columns to keep in front after modifications
front_cols <- c("YEAR", "School_ID", "WARD", "SIDE", "SCHOOL_NAME", "NAME_WARD_JOIN", "CY_BUDGET", "SCHOOL_TOTAL_ENROLLMENT")

# bin enrollment and spend values for comparison
school_data <- school_data %>% 
  mutate(
    ENROLLMENT_RANGE = cut(SCHOOL_TOTAL_ENROLLMENT, 
    breaks=c(0, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, Inf),
    labels=c("0-499", "500-999", "1,000-1,499", "1,500-1,999", 
             "2,000-2,499", "2,500-2,999", "3,000-3,499", 
             "3,500-3,999", "4,000-4,499", "4,500-4,999", "5,000+"), 
    ordered_result = TRUE),
        SPEND_RANGE = cut(AVG_SPEND_PER_STUDENT, 
                          breaks=c(0, 2500, 5000, 75000, 10000, 12500, 15000, Inf),
                          labels=c("0-2,499", "2,500-4,999", "5,000-7,499", 
                                   "7,500-9,999", "10,000-12,499", "12,500-14,999",
                                   "15,000+"), 
                          ordered_result = TRUE)) %>%
  dplyr::select(one_of(front_cols), ENROLLMENT_RANGE, SPEND_RANGE, everything())

# enable mapping by majority race in school
school_data <- left_join(
  school_data,
  school_data %>% group_by(`SCHOOL ID (R-C-D-T-S)`) %>% 
      summarise(
        White= mean(`SCHOOL - WHITE %`, na.rm=TRUE),
        Black= mean(`SCHOOL - BLACK %`, na.rm=TRUE),
        Asian= mean(`SCHOOL - ASIAN %`, na.rm=TRUE),
        Latinx = mean(`SCHOOL - HISPANIC %`, na.rm=TRUE)) %>% 
      gather(group_name, pct, -`SCHOOL ID (R-C-D-T-S)`) %>% 
      group_by(`SCHOOL ID (R-C-D-T-S)`) %>% 
      # sanity check to make sure all races in output to start before slicing
      # arrange(`SCHOOL ID (R-C-D-T-S)`)  %>%
      slice(which.max(pct)) %>% 
      dplyr::select(`SCHOOL ID (R-C-D-T-S)`, group_name, pct), 
  by = c("SCHOOL ID (R-C-D-T-S)")) %>% 
    dplyr::select(front_cols, ENROLLMENT_RANGE, SPEND_RANGE, 
      predominant_race = group_name, max_pct = pct, everything())
  

#########################
##  Quasi-Random Plot  ##
#########################
school_data %>% group_by(`SCHOOL ID (R-C-D-T-S)`, predominant_race) %>% 
  summarise(avg_LI_pct = mean(`LOW-INCOME SCHOOL %`, na.rm = TRUE),
                              school_count = n()) %>% 
  ggplot(aes(predominant_race, avg_LI_pct, color=factor(predominant_race))) +
      geom_quasirandom(varwidth=TRUE, size=3, show.legend = FALSE) +
  scale_color_dt("diverging", reverse = TRUE, na.value=get_dt_cols("palegray")) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  # scale_x_continuous(breaks=c(0, 25, 50, 75, 100)) +
  scale_x_discrete(position = "top", 
                   labels = c("Majority Asian Schools", "Majority Black Schools",
                             "Majority Latinx Schools", "Majority White Schools")) +
  theme_modest() + 
  theme(axis.text.x.top = element_text(size=rel(1.75), vjust = -8, face="bold"),
        axis.text.y = element_text(size=rel(1.25), margin=unit(c(0,0,0,3),"lines")),
        axis.title.y = element_text(size=rel(1.5), angle = 90, family = "Ledger"),
        axis.title.x = element_blank()
      # legend.title = element_text(size=rel(2)),
       #  legend.key.size =  unit(35, "pt"),
       # legend.text = element_text(size=rel(1.5))
       # plot.title = element_text(size=rel(2.5))
       ) +
  labs(title = "Majority Black and Majority Latinx Schools Have Much Higher Percentages of Low Income Students", 
       x="Predominant Race in School", 
       y="Percentage of Low Income Students", caption="Data Source: Illinois State Board of Education, Annual Report Cards") + 
    annotate("text", y = 30, x = 2.4, label = "A handful of Near West Side\nand Wicker Park schools buck\nthe overall trend.", hjust=0.5, size=rel(7), face="bold") + 
  annotate("segment", x = 2.55, xend = 2.975, y = 33, yend = 40) +
  annotate("segment", x = 2.7, xend = 2.975, y = 30, yend = 31) +
  annotate("segment", x = 2.05, xend = 2.2, y = 26, yend = 28) +
  annotate("text", x = 2.45, y= 18, label="Keller Gifted Magnet Elementary School*", hjust=0.5, size=rel(7), fontface="bold") + 
  annotate("text", x = 1.3, y= 53, label="Sheridan Math & Science\nAcademy in Chinatown", hjust=0.5, size=rel(7), face="bold") +
  annotate("text", x = 1.45, y= 26, label="Rates at South Loop Elementary School\nand Lenart Regional Gifted Center\nElementary School located six blocks from\nthe University of Chicago are likely\nreflective of overall higher median\nincomes in the schools' neighborhoods.", hjust=0.5, size=rel(7), face="bold") +
  annotate("segment", x = 1.875, xend = 1.975, y = 30, yend = 33) +
  annotate("segment", x = 1.875, xend = 1.975, y = 30, yend = 30.5) +
  annotate("text", x=1.65, y = 38, label="Sutherland Elementary School*",hjust=0.5, size=rel(7), fontface="bold") + 
    annotate("text", x=3.6, y = 80, label="Schools near Humbolt Park and\nO'Hare have comparably high rates\nof low-income White students.",hjust=0.5, size=rel(7), face="bold") + 
  annotate("text", x = 1.15, y = 5, label = "*Keller Gifted Magnet and Sutherland Elementary Schools in the neighboring Mt. Greenwood and Beverly communities on the Far\nSouthwest Side have two of the smallest differences between white and non-white student percentages across all non-white schools.", hjust=0, size=rel(7), face="bold")
```
On average over the last 5 school years, non-white schools have served significantly higher percentages of low-income students, as determined by free and reduced lunch designation. It seems to follow that these schools would provide more resources for students, however over the same time period, average spend per student remains roughly the same across schools, with an increase in the spread of spending distribution after each of the two recent funding formula changes.

```{r sanity-check-quasi, echo=TRUE, include=FALSE, eval=FALSE}
# sanity check number of majority white schools out of 721, seems low
school_data %>% group_by(predominant_race) %>% 
  distinct(predominant_race, `SCHOOL ID (R-C-D-T-S)`) %>% 
  arrange(predominant_race, `SCHOOL ID (R-C-D-T-S)`) %>% summarise(schools = n()
                                                                   )
```

```{r gganimate_budget, fig, fig.height=12, fig.width=15, message=FALSE, warning=FALSE}
 
library(gganimate)
# library(gapminder)
school_data %>% mutate(NONWHITE_PCT = (100 - as.numeric(`SCHOOL - WHITE %`)),
                       DIFF_NONWHITE = NONWHITE_PCT - as.numeric(`SCHOOL - WHITE %`)) %>% 
  arrange(desc(predominant_race), DIFF_NONWHITE) %>% 
  dplyr::select(front_cols, predominant_race, NONWHITE_PCT, DIFF_NONWHITE, everything()) %>%   
ggplot(aes(NONWHITE_PCT, AVG_SPEND_PER_STUDENT, frame = as.integer(YEAR))) +
  geom_point(alpha = 0.5, show.legend = FALSE, aes(size = `OVERALL AVERAGE CLASS SIZE - SCHOOL`,
           colour = predominant_race)) +
  scale_size(range = c(2, 12)) +
  scale_color_dt("diverging", reverse = TRUE, na.value=get_dt_cols("palegray")) +
  enter_fade() +
  exit_fade() +
  theme_modest() +
  theme(
        axis.text.y = element_text(margin=unit(c(0,0,0,2),"lines")),
        axis.text.x = element_text(margin=unit(c(2,0,0,0),"lines")),
        panel.grid.minor.y = element_blank(),
        axis.text = element_text(size=rel(0.5)),
        axis.title.x = element_text(size=rel(0.75), family = "Ledger"),
        plot.subtitle = element_text(size=rel(0.65), hjust = 1),
        plot.title = element_text(size=rel(0.90), hjust = .5),
        axis.title.y = element_text(size=rel(0.75), angle = 90, family = "Ledger")
  ) +
  
  # Here comes the gganimate specific bits
  labs(subtitle = 'Year: {frame_time}', x = 'Non-White Student Percentage', y = 'Average Spend per Student',
       title = "Spread of Spend per Student Increases\nafter 2017, 2018 School Funding Formula Changes") +
  # transition_components(`SCHOOL ID (R-C-D-T-S)`, as.integer(YEAR)) +
  gganimate::transition_components(time=as.integer(YEAR)) +
  ease_aes('sine-in-out')

```




```{r geo-attempt}
# all_demos <-  readRDS(here::here("data", "all_demos_chi.Rda"))

# wards_w_all_demos <- st_join(wards.2015, st_transform(all_demos, crs =  st_crs(wards.2015)), largest=TRUE)
# beg_mid_end_wards_all_demos <- wards_w_all_demos %>% filter(YEAR %in% c(2012, 2015, 2017))
```


```{r geo-attempt-contd fig.height=12, fig.width=15}
# 
# beg_mid_end_wards_all_demos %>% filter(YEAR %in% c(2012, 2015, 2017)) %>%
#   ggplot() + 
#     geom_sf(aes(fill=medianIncome), alpha=0.5) + 
#   scale_fill_dt("cool", discrete=FALSE, reverse=TRUE, na.value=get_dt_cols("palegray")) +
#   geom_sf(aes(color=predominant_race), fill=NA, lwd=3) +
#   scale_color_dt("diverging", discrete=TRUE, na.value=get_dt_cols("palegray"))  +
#   theme_map_modest() +
#   facet_wrap(~YEAR)

```


```{r area-chart, fig.height=12, fig.width=15, message=FALSE, warning=FALSE}
school_data %>% group_by(YEAR, SIDE) %>% 
  summarise(median_spend = min(AVG_SPEND_PER_STUDENT)) %>% 
  ggplot(aes(y=median_spend, x=as.numeric(YEAR))) +
  # geom_line(aes(y=AVG_SPEND_PER_STUDENT, x=YEAR)) +
  geom_area(aes(group=as.factor(SIDE), fill=SIDE)) +
    scale_fill_dt(na.value=get_dt_cols("palegray")) +
  theme_modest() +
  theme(legend.text = element_text(size=rel(1)),
        legend.title = element_text(size=rel(1)),
        axis.title.x = element_text(family = "Ledger"),
        axis.title.y = element_text(angle = 90, family = "Ledger")
        ) +
          labs(y= "Median Spend per Student", x="Year", caption="Data Source: Chicago Public Schools, Find Your School Budget & Illinois State Board of Education, Annual Report Cards")
```

```{r include= FALSE}
# To Look Into: is attendance higher in majority low income schools (>50%) in areas with higher SNAP takeup? 
# how to combine census data set to compare over time...
```





